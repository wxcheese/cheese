<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wxCheese - Where your smile grows and travels far</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥æ€æºå®‹ä½“ï¼Œå¢å¼ºç¦…æ„ç¾å­¦ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ç¦…æ„é…è‰²æ–¹æ¡ˆ */
            --zen-gold: #9E7B5B; /* æŸ”å’Œçš„ç ‚é‡‘ */
            --zen-sand: #FBF9F6; /* æ¥è¿‘çº¯ç™½çš„èƒŒæ™¯ */
            --zen-ink: #333333; /* æ·±å¢¨è‰² */
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--zen-sand); /* çº¯ç™½èƒŒæ™¯ */
            color: var(--zen-ink);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* ç¡®ä¿çº¯å‡€çš„ç”»å¸ƒæ•ˆæœ */
        }
        /* æ ¸å¿ƒå±…ä¸­å®¹å™¨ */
        .wisdom-container {
            max-width: 80%;
            text-align: center;
            padding: 20px;
        }
        /* åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 1.2s ease-out forwards; /* åŠ¨ç”»æ›´æ…¢ã€æ›´å¹³æ»‘ */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    
    <!-- æ ¸å¿ƒ JavaScript é€»è¾‘ï¼šæ ¼è¨€è·å–ã€ä¸€æœŸä¸€ä¼šç¼–å· -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // å¼•å…¥äº‹åŠ¡ (runTransaction) æ¥ç¡®ä¿è®¡æ•°å™¨å‡†ç¡®æ€§
        import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Configuration ---
        const GEMINI_API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        const GEMINI_API_KEY = ""; // Canvas will provide key at runtime
        
        // ç®€åŒ–è·¯å¾„ï¼šåªä½¿ç”¨ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨æ–‡æ¡£
        const COUNTER_DOC_PATH = "artifacts/global/counters/visitor_count";
        const USER_VISIT_COLLECTION = "artifacts/global/visits"; 

        let db;
        let auth;
        let app; // Global declaration for app instance
        let isCounterInitialized = false; 

        // ----------------------------------------------------
        // ** ğŸš¨ REAL FIREBASE CONFIGURATION AREA ğŸš¨ **
        // ----------------------------------------------------
        // When deploying to Vercel, ensure this object contains your actual keys.
        const REAL_FIREBASE_CONFIG = {
          apiKey: "AIzaSyC5yS2OFfbhX7qA37CJGMMtWNYu96RYM",
          authDomain: "semiotic-sylph-418318.firebaseapp.com",
          projectId: "semiotic-sylph-418318",
          storageBucket: "semiotic-sylph-418318.appspot.com",
          messagingSenderId: "788592797598",
          appId: "1:788592797598:web:fcbc0f2b38d4c365e2ff67"
        };
        // ----------------------------------------------------


        /**
         * Fetch function with exponential backoff for resilience.
         */
        async function fetchWithRetry(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url + GEMINI_API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 400 || response.status === 401) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * Initializes Firebase and starts auth process.
         */
        async function initializeFirebase() {
            try {
                let firebaseConfig = null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
                const canvasConfigExists = typeof __firebase_config !== 'undefined';
                
                // --- Start of Configuration Priority Fix ---
                if (initialAuthToken && canvasConfigExists) {
                    // Scenario 1: Canvas environment is active. Use its paired config and token.
                    // This is the most reliable config in Canvas when a token is present.
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (REAL_FIREBASE_CONFIG && REAL_FIREBASE_CONFIG.projectId) {
                    // Scenario 2: Deployment environment (Vercel). Use the user's hardcoded config.
                    firebaseConfig = REAL_FIREBASE_CONFIG;
                } else if (canvasConfigExists) {
                    // Scenario 3: Fallback to Canvas config if REAL_FIREBASE_CONFIG is missing
                    firebaseConfig = JSON.parse(__firebase_config);
                }
                // --- End of Configuration Priority Fix ---


                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing.");
                    return;
                }

                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authentication Logic
                if (initialAuthToken) {
                    // Use the secure token provided by the Canvas environment (prevents API key error)
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously for deployment environments (Vercel)
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes to get the UID
                onAuthStateChanged(auth, async (user) => {
                    if (user && !isCounterInitialized) {
                        isCounterInitialized = true;
                        await initializeCounter(user.uid);
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                document.getElementById('user-counter').textContent = '#Auth-Error';
            }
        }
        
        /**
         * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¿é—®è¿‡ï¼Œå¹¶åˆ†é…æˆ–è¯»å–åºå·ã€‚
         */
        async function initializeCounter(uid) {
            try {
                const counterRef = doc(db, COUNTER_DOC_PATH);
                const visitorRef = doc(db, USER_VISIT_COLLECTION, uid);
                const counterElement = document.getElementById('user-counter');

                let currentNumber;
                let visitorDoc = await getDoc(visitorRef);

                // å¦‚æœç”¨æˆ·æ˜¯é¦–æ¬¡è®¿é—® (UIDåœ¨è®¿é—®è®°å½•ä¸­ä¸å­˜åœ¨)
                if (!visitorDoc.exists()) {
                    
                    // é¦–æ¬¡è®¿é—®ï¼šä½¿ç”¨äº‹åŠ¡å®‰å…¨åœ°é€’å¢å…¨å±€è®¡æ•°å™¨
                    currentNumber = await runTransaction(db, async (transaction) => {
                        const snap = await transaction.get(counterRef);
                        let newCount = snap.exists() ? snap.data().value + 1 : 1;
                        
                        // æ›´æ–°å…¨å±€è®¡æ•°å™¨
                        transaction.set(counterRef, { value: newCount });
                        // è®°å½•ç”¨æˆ·è®¿é—®åºå·
                        transaction.set(visitorRef, { serial: newCount });
                        
                        return newCount;
                    });
                    
                } else {
                    // é‡å¤è®¿å®¢ï¼šè¯»å–ä»–ä»¬å·²åˆ†é…çš„ç¼–å·
                    currentNumber = visitorDoc.data().serial || 0; 
                }

                counterElement.textContent = `#${currentNumber}`;
                
            } catch (e) {
                console.error("Error initializing counter:", e);
                document.getElementById('user-counter').textContent = '#DB-Error';
            }
        }


        /**
         * Fetches the random English Zen quote using Gemini API.
         */
        async function fetchInitialWisdom() {
            const quoteElement = document.getElementById('wisdom-quote');
            
            // éšæœºç§å­ç¡®ä¿æ¯æ¬¡åˆ·æ–°è·å¾—ä¸åŒçš„é‡‘å¥
            const randomSeed = Math.random().toString(36).substring(2, 7); 

            // ç³»ç»Ÿæç¤ºç¡®ä¿å†…å®¹ç®€æ´ä¸”å›ºå®šä¸ºè‹±æ–‡
            const systemPrompt = `You are a supremely wise Zen master. Provide a single, concise, profound English phrase or sentence for guidance and introspection for the day. The quote MUST NOT be longer than 20 characters (including spaces). Do not include any punctuation, sources, or quotation marks.`;
            const userQuery = `Give me a unique maxim about the present moment, impermanence, or simplicity. Seed: ${randomSeed}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const result = await fetchWithRetry(GEMINI_API_URL_TEXT, payload);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 
                             "The present moment is your final master"; // Fallback
                
                // è®¾ç½®å†…å®¹å¹¶è§¦å‘æ·¡å…¥åŠ¨ç”»
                quoteElement.textContent = text.trim();
                quoteElement.classList.add('fade-in');
                
            } catch (e) {
                console.error("Error fetching wisdom quote:", e);
                quoteElement.textContent = "The present moment is your final master"; // Fallback
                quoteElement.classList.add('fade-in'); 
            }
        }
        
        // Launch application upon window load
        window.onload = function() {
             initializeFirebase(); 
             fetchInitialWisdom();
        };

    </script>
</head>
<body>

    <!-- Top Bar: Serial Number -->
    <header class="fixed top-4 right-4 z-10 p-4">
        <div class="text-right flex flex-col items-end">
            <!-- Serial number only -->
            <p id="user-counter" class="text-xl font-extrabold text-zen-gold">#Loading</p>
        </div>
    </header>

    <!-- Main Canvas Content: Pure Quote -->
    <div class="wisdom-container">
        <!-- Main Quote -->
        <h1 id="wisdom-quote" class="text-4xl md:text-6xl font-bold text-zen-ink opacity-0 transition-opacity">
            Contemplating...
        </h1>
    </div>
    
    <!-- Footer: Alert Message Container (Placeholder) -->
    <div id="alert-container" class="fixed bottom-4 right-4 z-50 flex flex-col items-end pointer-events-none">
    </div>

</body>
</html>
