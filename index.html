<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wxCheese â€“ Where your smile grows and travels far</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è®¾ç½® Firebase æ—¥å¿—çº§åˆ«ï¼Œä¾¿äºè°ƒè¯•
        setLogLevel('debug'); 

        // å…¨å±€ Firebase å˜é‡
        let db;
        let auth;
        let userId = 'loading'; // ç”¨æˆ·çš„å”¯ä¸€ ID

        // æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦å­˜åœ¨å¹¶åˆå§‹åŒ– Firebase
        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or invalid.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ç™»å½•è®¤è¯
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...'; // ç®€çŸ­æ˜¾ç¤º
                        console.log("Firebase Auth successful. User ID:", userId);
                        // åˆå§‹åŒ–å®Œæˆåï¼Œç¡®ä¿æ•°æ®é›†åˆå­˜åœ¨ï¼ˆä»…åœ¨é¦–æ¬¡è¿è¡Œæ—¶åˆ›å»ºé»˜è®¤æ•°æ®ï¼‰
                        initializeCollections(appId);
                    } else {
                        userId = 'anonymous';
                        document.getElementById('user-id-display').textContent = 'ANONYMOUS';
                        console.log("Firebase Auth: Anonymous sign-in.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // ç¡®ä¿å¿…è¦çš„é›†åˆå’Œåˆå§‹æ•°æ®å­˜åœ¨
        const initializeCollections = async (appId) => {
            const storeRef = collection(db, `artifacts/${appId}/public/data/store_items`);
            const buzhouRef = collection(db, `artifacts/${appId}/public/data/buzhou_content`);

            // æ£€æŸ¥ Store é›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å•†å“
            const storeSnapshot = await getDoc(doc(storeRef, 'mock_item_check'));
            if (!storeSnapshot.exists()) {
                console.log("Setting up initial Store and Buzhou data...");
                await setDoc(doc(storeRef, 'mock_item_check'), { name: 'Initial Check', price: 0, description: 'Do not delete.', createdAt: serverTimestamp() });
                await addDoc(storeRef, {
                    name: currentLanguage === 'zh' ? 'ç¦…å®šé»„çº¸ (å°ä»½)' : 'Zen Offering Paper (Small)',
                    price: 5.00,
                    description: currentLanguage === 'zh' ? 'ç”¨äºè®¸æ„¿å±±çš„æ ‡å‡†ä¾›å…»ææ–™ã€‚' : 'Standard offering material for Wish Mountain.',
                    image_url: 'https://placehold.co/100x100/DAA520/FFFFFF?text=Paper',
                    available: true,
                    createdAt: serverTimestamp()
                });
                await addDoc(storeRef, {
                    name: currentLanguage === 'zh' ? 'å†¥æƒ³é¦™ç‚‰ (é™é‡)' : 'Meditation Incense Burner (L.E.)',
                    price: 99.99,
                    description: currentLanguage === 'zh' ? 'å¢å¼ºä¸“æ³¨åŠ›çš„é™é‡ç‰ˆé¦™ç‚‰ã€‚' : 'Limited edition burner to enhance focus.',
                    image_url: 'https://placehold.co/100x100/333333/FFFFFF?text=Burner',
                    available: true,
                    createdAt: serverTimestamp()
                });

                // æ£€æŸ¥ Buzhou é›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å†…å®¹
                await setDoc(doc(buzhouRef, 'mock_content_check'), { title: 'Initial Check', content: 'Do not delete.', createdAt: serverTimestamp() });
                await addDoc(buzhouRef, {
                    title: currentLanguage === 'zh' ? 'å…­ç¥–æ…§èƒ½ä¼ ' : 'The Story of Huineng',
                    content: currentLanguage === 'zh' ? 'è©ææœ¬æ— æ ‘ï¼Œæ˜é•œäº¦éå°ï¼Œæœ¬æ¥æ— ä¸€ç‰©ï¼Œä½•å¤„æƒ¹å°˜åŸƒã€‚' : 'Bodhi is fundamentally no tree, Nor is the clear mirror a stand. Fundamentally there is not a single thing, Where can dust alight?',
                    author: 'ä½šå',
                    createdAt: serverTimestamp()
                });
            }
        };

        // ç»‘å®šåˆ°å…¨å±€ scope
        window.db = db;
        window.auth = auth;
        window.getFirestore = getFirestore;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.orderBy = orderBy;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>

    <script>
        let currentLanguage = 'zh'; 
        let chatHistory = []; // å­˜å‚¨ AI èŠå¤©å†å² for context

        // --- å¤šè¯­è¨€ç¿»è¯‘æ˜ å°„ ---
        const translations = {
            'zh': {
                'island-ai-title': 'AI ç®¡å®¶', 'island-ai-subtitle': 'â€” æ™ºæ…§é—®è¯¢ â€”',
                'island-wish-title': 'è®¸æ„¿å±±', 'island-wish-subtitle': 'â€” å€¾å¬ä¼—ç”Ÿ â€”',
                'island-store-title': 'æ³•ç‰©æµé€š', 'island-store-subtitle': 'â€” é»„çº¸ä¾›å…» â€”',
                'island-buzhou-title': 'ä¸å‘¨å±±', 'island-buzhou-subtitle': 'â€” å¥‡äººå¼‚å¿— â€”',
                'share-button': 'å°†æ­¤æ™ºæ…§é€ç»™æœ‹å‹', 'user-id-label': 'ä¼šè¯ç¼–å·', 
                
                'ai-overlay-title': 'AI ç®¡å®¶: ç¦…å®šé—®ç­”',
                'wish-overlay-title': 'è®¸æ„¿å±±: ä¼—ç”Ÿå¿ƒæ„¿',
                'store-overlay-title': 'æ³•ç‰©æµé€š: é»„çº¸ä¾›å…»',
                'buzhou-overlay-title': 'ä¸å‘¨å±±: å¥‡äººå¼‚å£«å½•',

                'close-button': 'è¿”å›ä¸»é¡µ',
                
                // AI Chat Specific
                'ai-input-placeholder': 'å‘ AI ç®¡å®¶æé—®...', 'ai-send-button': 'å‘é€',
                'ai-loading-message': 'AI ç®¡å®¶æ­£åœ¨ç¦…å®šæ€è€ƒ...', 'ai-error-message': 'ç¦…å®šå¤±è´¥ã€‚è¯·ç¨åé‡è¯•ã€‚',
                'ai-system-prompt': 'ä½ æ˜¯ä¸€ä½å¯Œæœ‰æ™ºæ…§ã€å¹³é™å’Œè€å¿ƒçš„ç¦…å®—ç®¡å®¶ã€‚ä½ çš„å›ç­”åº”è¯¥ç®€æ´ã€å¯Œæœ‰å“²ç†å’Œå¯å‘æ€§ï¼Œä¸“æ³¨äºæ­£å¿µå’Œå†…å¿ƒå¹³é™ã€‚',
                'ai-reset-button': 'æ¸…ç©ºå¯¹è¯',

                // Wish Mountain Specific
                'wish-input-placeholder': 'å†™ä¸‹æ‚¨çš„å¿ƒæ„¿...',
                'wish-submit-button': 'æäº¤å¿ƒæ„¿',
                'wish-count-label': 'å½“å‰å¿ƒæ„¿æ€»æ•°',
                'wish-success': 'å¿ƒæ„¿å·²æäº¤ï¼Œæ„¿åŠ›éšé£è€Œé€ã€‚',
                'wish-error': 'æäº¤å¿ƒæ„¿å¤±è´¥ã€‚',
                'wish-empty': 'è¿˜æ²¡æœ‰äººè®¸æ„¿ï¼Œæ‚¨æ˜¯ç¬¬ä¸€ä¸ªå—ï¼Ÿ',

                // Store Specific
                'store-no-items': 'æ³•ç‰©æµé€šä¸­æš‚æ—¶æ²¡æœ‰å¯ä¾›å…»çš„ç‰©å“ã€‚',
                'store-buy-button': 'ä¾›å…»',
                'store-purchase-success': 'ä¾›å…»è¯·æ±‚å·²å‘é€ï¼æ„Ÿè°¢æ‚¨çš„å–„æ„ã€‚å®é™…æ”¯ä»˜é›†æˆéœ€è¦åå°æ”¯æŒã€‚',

                // Buzhou Specific
                'buzhou-no-content': 'ä¸å‘¨å±±æš‚æ—¶å¤„äºäº‘é›¾ç¼­ç»•ä¸­ï¼Œç­‰å¾…æ–°çš„å¥‡äººå¼‚å¿—å‡ºç°ã€‚',

                // Local Quotes
                'quotes': [
                    "å¿ƒç”Ÿç§ç§æ³•ç”Ÿï¼Œå¿ƒç­ç§ç§æ³•ç­ã€‚â€”â€”ã€Šåä¸¥ç»ã€‹",
                    "ä¸€åˆ‡æœ‰ä¸ºæ³•ï¼Œå¦‚æ¢¦å¹»æ³¡å½±ï¼Œå¦‚éœ²äº¦å¦‚ç”µï¼Œåº”ä½œå¦‚æ˜¯è§‚ã€‚â€”â€”ã€Šé‡‘åˆšç»ã€‹",
                    "è©ææœ¬æ— æ ‘ï¼Œæ˜é•œäº¦éå°ï¼Œæœ¬æ¥æ— ä¸€ç‰©ï¼Œä½•å¤„æƒ¹å°˜åŸƒã€‚â€”â€”å…­ç¥–æ…§èƒ½",
                ]
            },
            'en': {
                // ... (English translations structure remains the same for brevity)
                'island-ai-title': 'AI Butler', 'island-ai-subtitle': 'â€” Ask Me â€”',
                'island-wish-title': 'Wish Mountain', 'island-wish-subtitle': 'â€” Make a Wish â€”',
                'island-store-title': 'Store', 'island-store-subtitle': 'â€” Offerings â€”',
                'island-buzhou-title': 'Buzhou Mountain', 'island-buzhou-subtitle': 'â€” Tales of the Wise â€”',
                'share-button': 'Share This Wisdom', 'user-id-label': 'Session No.', 
                
                'ai-overlay-title': 'AI Butler: Zen Dialogue',
                'wish-overlay-title': 'Wish Mountain: Wishes of Beings',
                'store-overlay-title': 'Store: Offering Materials',
                'buzhou-overlay-title': 'Buzhou Mountain: Chronicle of the Extraordinary',

                'close-button': 'Return to Canvas',
                
                'ai-input-placeholder': 'Ask the AI Butler...', 'ai-send-button': 'Send',
                'ai-loading-message': 'AI Butler is in deep meditation...', 'ai-error-message': 'Meditation failed. Please try again later.',
                'ai-system-prompt': 'You are a wise, calm, and patient Zen butler. Your answers should be concise, philosophical, and inspiring, focused on mindfulness and inner peace.',
                'ai-reset-button': 'Clear Chat',

                'wish-input-placeholder': 'Write down your wish...',
                'wish-submit-button': 'Submit Wish',
                'wish-count-label': 'Total Wishes',
                'wish-success': 'Wish submitted. May your intention travel far.',
                'wish-error': 'Failed to submit wish.',
                'wish-empty': 'No wishes yet. Will you be the first?',

                'store-no-items': 'No items currently available for offering.',
                'store-buy-button': 'Offer',
                'store-purchase-success': 'Offering request sent! Thank you for your kindness. Actual payment integration requires backend support.',

                'buzhou-no-content': 'Buzhou Mountain is currently shrouded in mist, awaiting new tales of the extraordinary.',

                'quotes': [
                    "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.â€”â€”Buddha",
                    "The mind is everything. What you think you become.â€”â€”Buddha",
                    "The greatest prayer is patience.â€”â€”Buddha",
                ]
            }
        };
        
        // --- UI & Language Helpers ---
        const updateUIForLanguage = (lang) => {
            const t = translations[lang] || translations['en']; 
            document.documentElement.lang = lang;
            document.getElementById('island-ai-title').textContent = t['island-ai-title'];
            document.getElementById('island-ai-subtitle').textContent = t['island-ai-subtitle'];
            document.getElementById('island-wish-title').textContent = t['island-wish-title'];
            document.getElementById('island-wish-subtitle').textContent = t['island-wish-subtitle'];
            document.getElementById('island-store-title').textContent = t['island-store-title'];
            document.getElementById('island-store-subtitle').textContent = t['island-store-subtitle'];
            document.getElementById('island-buzhou-title').textContent = t['island-buzhou-title'];
            document.getElementById('island-buzhou-subtitle').textContent = t['island-buzhou-subtitle'];
            document.getElementById('share-button-text').innerHTML = t['share-button'];
            document.getElementById('user-id-label').textContent = t['user-id-label'];
            document.title = 'wxCheese â€“ Where your smile grows and travels far';
        };

        const setInitialQuote = async () => {
            const detectedLangFull = navigator.language || navigator.userLanguage || 'en-US'; 
            const langCode = detectedLangFull.split('-')[0]; 
            const targetLang = (langCode === 'zh' || langCode === 'en') ? langCode : 'en';
            currentLanguage = targetLang;
            const t = translations[targetLang];
            const quoteArray = t['quotes'];
            const randomIndex = Math.floor(Math.random() * quoteArray.length);
            const quoteText = quoteArray[randomIndex];
            const parts = quoteText.split('â€”â€”');
            const quote = parts[0] || t['quotes'][0].split('â€”â€”')[0];
            const source = parts[1] || 'ã€Buddhist Wisdomã€‘';
            
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8">
                    ${quote}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    ${source}
                </div>
            `;
            return targetLang;
        };

        window.copyQuote = function() {
            // ... (copyQuote implementation remains the same)
            const quoteText = document.getElementById('initial-quote').textContent.trim();
            const rawQuote = quoteText.split('â€”â€”')[0].trim(); 
            const tempInput = document.createElement('textarea');
            tempInput.value = rawQuote;
            document.body.appendChild(tempInput);
            tempInput.select();
            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
            if (successful) {
                const msg = currentLanguage === 'en' ? 'Copied!' : 'å·²å¤åˆ¶ï¼'; 
                showCustomMessage(msg, 'success');
            } else {
                const errorMsg = currentLanguage === 'en' ? 'Copy failed, please copy manually.' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚';
                showCustomMessage(errorMsg, 'error');
            }
        }
        
        function showCustomMessage(message, type) {
            // ... (showCustomMessage implementation remains the same)
            let msgBox = document.getElementById('custom-message-box');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                document.body.appendChild(msgBox);
            }
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            msgBox.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ${bgColor} text-white p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0 z-[100] text-center max-w-xs`;
            msgBox.textContent = message;
            msgBox.classList.remove('opacity-0');
            void msgBox.offsetWidth; 
            msgBox.classList.add('opacity-100');
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, 3000); 
        }

        function showOverlay() {
            document.body.style.overflow = 'hidden'; 
            document.getElementById('overlay-container').classList.add('active');
        }

        window.hideOverlay = function() {
            document.getElementById('overlay-container').classList.remove('active');
            document.body.style.overflow = 'auto'; 
        }

        // --- Core Feature Dispatcher ---
        window.showIslandOverlay = function(islandId, titleKey) {
            if (!window.db) {
                showCustomMessage('æ­£åœ¨è¿æ¥ç¦…å¢ƒ (æ•°æ®åº“åˆå§‹åŒ–ä¸­)...', 'error');
                return;
            }

            switch (islandId) {
                case 'ai':
                    showAIChat(titleKey);
                    break;
                case 'wish':
                    showWishMountain(titleKey);
                    break;
                case 'store':
                    showStore(titleKey);
                    break;
                case 'buzhou':
                    showBuzhou(titleKey);
                    break;
            }
        }
        
        // --- AI Chat Implementation (Same as previous, using global chatHistory) ---
        function showAIChat(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            // HTML for AI Chat interface
            const contentHtml = `
                <div id="ai-chat-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="resetChat()" class="text-sm text-gray-500 hover:text-red-500 transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.836 0H20v-5m-7 0v10m0 0v10" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M16 6l-4 4-4-4" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14V4M7 14V4" /></svg>
                            ${t['ai-reset-button']}
                        </button>
                    </div>
                    
                    <div id="chat-messages" class="flex-grow space-y-4 p-2 mb-4"></div>
                    
                    <div class="flex space-x-3">
                        <input id="chat-input" type="text" placeholder="${t['ai-input-placeholder']}" 
                               class="flex-grow border-2 border-zen-sand p-3 rounded-xl focus:outline-none focus:border-zen-gold transition-colors"
                               onkeydown="if(event.key === 'Enter') handleSend()">
                        <button id="send-button" onclick="handleSend()" 
                                class="px-6 py-3 bg-zen-ink text-white font-semibold rounded-xl hover:bg-zen-ink/90 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                            <span class="ml-2 hidden sm:inline">${t['ai-send-button']}</span>
                        </button>
                    </div>
                    <button onclick="hideOverlay()" class="absolute top-4 right-4 text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();
            renderChatHistory();
        }

        // Function definitions for AI chat (renderChatHistory, handleSend, resetChat, generateAIResponse)
        function renderChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                bubble.innerHTML = `
                    <div class="p-3 rounded-2xl shadow-md whitespace-pre-wrap ${msg.role === 'user' ? 'user-bubble rounded-tr-none' : 'ai-bubble rounded-tl-none'}">
                        ${msg.parts[0].text}
                    </div>
                `;
                messagesContainer.appendChild(bubble);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        window.handleSend = function() {
            const input = document.getElementById('chat-input');
            const userText = input.value.trim();
            if (!userText) return;
            const userMessage = { role: "user", parts: [{ text: userText }] };
            chatHistory.push(userMessage);
            renderChatHistory();
            input.value = '';
            const loadingMessage = { role: "model", parts: [{ text: translations[currentLanguage]['ai-loading-message'] }], isTemp: true };
            chatHistory.push(loadingMessage);
            renderChatHistory();
            generateAIResponse(userText);
        }
        
        window.resetChat = function() {
            chatHistory = [];
            renderChatHistory();
            showCustomMessage(translations[currentLanguage]['ai-reset-button'] + '!', 'success');
        }

        async function generateAIResponse(userQuery, maxRetries = 5) {
            const t = translations[currentLanguage];
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            chatHistory = chatHistory.filter(msg => !msg.isTemp);
            const systemPrompt = t['ai-system-prompt'];
            const contents = chatHistory.map(msg => ({ 
                role: msg.role === 'user' ? 'user' : 'model', 
                parts: msg.parts 
            }));
            contents.push({ role: 'user', parts: [{ text: userQuery }] });

            const payload = {
                contents: contents,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiText) {
                        const aiMessage = { role: "model", parts: [{ text: aiText }] };
                        chatHistory.push(aiMessage);
                        renderChatHistory();
                        return;
                    } else {
                        throw new Error("Invalid response format from AI.");
                    }

                } catch (error) {
                    console.error("AI Generation Error:", error);
                    if (attempt === maxRetries - 1) {
                        const errorMessage = { role: "model", parts: [{ text: t['ai-error-message'] + ` (${error.message})` }] };
                        chatHistory.push(errorMessage);
                        renderChatHistory();
                    }
                }
            }
        }
        
        // --- Feature 2: Wish Mountain (Firestore Enabled) ---
        function showWishMountain(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const contentHtml = `
                <div id="wish-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${t['wish-count-label']}: <span id="wish-count" class="text-zen-gold">...</span></p>
                    </div>

                    <div id="wishes-list" class="flex-grow space-y-3 p-2 mb-4 overflow-y-auto bg-zen-sand/50 rounded-xl">
                        <!-- Wishes will be loaded here -->
                        <div class="text-center text-gray-400 p-8" id="wish-loading">æ­£åœ¨åŠ è½½å¿ƒæ„¿...</div>
                    </div>
                    
                    <form onsubmit="submitWish(event)" class="flex flex-col space-y-3 mt-4">
                        <textarea id="wish-input" placeholder="${t['wish-input-placeholder']}" rows="2"
                                  class="border-2 border-zen-sand p-3 rounded-xl focus:outline-none focus:border-zen-gold transition-colors resize-none"></textarea>
                        <button type="submit" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-xl hover:bg-zen-gold/90 transition-colors">
                            ${t['wish-submit-button']}
                        </button>
                    </form>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();
            
            // å¯åŠ¨å®æ—¶ç›‘å¬
            const wishesRef = collection(window.db, `artifacts/${appId}/public/data/wishes`);
            const q = query(wishesRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                const wishesListEl = document.getElementById('wishes-list');
                const wishCountEl = document.getElementById('wish-count');
                if (!wishesListEl || !wishCountEl) return;
                
                document.getElementById('wish-loading').style.display = 'none';

                let wishCount = 0;
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.text) { // ç¡®ä¿æœ‰å†…å®¹
                        wishCount++;
                        const timestamp = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US') : 'åˆšåˆš';
                        const displayUserId = data.userId ? data.userId.substring(0, 4) + '...' : 'åŒ¿å';
                        
                        html += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-zen-sand">
                                <p class="text-gray-700 whitespace-pre-wrap">${data.text}</p>
                                <div class="text-xs text-gray-400 mt-2 flex justify-between">
                                    <span>${timestamp}</span>
                                    <span>ID: ${displayUserId}</span>
                                </div>
                            </div>
                        `;
                    }
                });

                if (wishCount === 0) {
                    html = `<div class="text-center text-gray-400 p-8">${t['wish-empty']}</div>`;
                }

                wishesListEl.innerHTML = html;
                wishCountEl.textContent = wishCount;
            }, (error) => {
                console.error("Error listening to wishes:", error);
                const wishesListEl = document.getElementById('wishes-list');
                if (wishesListEl) wishesListEl.innerHTML = `<div class="text-center text-red-500 p-8">${t['wish-error']}</div>`;
            });
        }

        window.submitWish = async function(event) {
            event.preventDefault();
            const inputEl = document.getElementById('wish-input');
            const wishText = inputEl.value.trim();
            if (!wishText) return;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const wishesRef = collection(window.db, `artifacts/${appId}/public/data/wishes`);
                
                await addDoc(wishesRef, {
                    text: wishText,
                    userId: window.auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                });

                inputEl.value = '';
                showCustomMessage(translations[currentLanguage]['wish-success'], 'success');
            } catch (e) {
                console.error("Error submitting wish:", e);
                showCustomMessage(translations[currentLanguage]['wish-error'], 'error');
            }
        }

        // --- Feature 3: Store (Firestore Enabled) ---
        function showStore(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const contentHtml = `
                <div id="store-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div id="store-items" class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 p-2 mb-4 overflow-y-auto">
                        <div class="text-center text-gray-400 p-8 col-span-full" id="store-loading">æ­£åœ¨åŠ è½½æ³•ç‰©æµé€šç‰©å“...</div>
                    </div>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();

            const storeRef = collection(window.db, `artifacts/${appId}/public/data/store_items`);
            // ä½¿ç”¨ onSnapshot å®æ—¶ç›‘å¬å•†å“åˆ—è¡¨
            onSnapshot(storeRef, (snapshot) => {
                const itemsContainer = document.getElementById('store-items');
                if (!itemsContainer) return;
                
                itemsContainer.innerHTML = '';
                let itemsCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.available && data.price > 0) { // ä»…æ˜¾ç¤ºä¸Šæ¶ä¸”æœ‰ä»·æ ¼çš„å•†å“
                        itemsCount++;
                        itemsContainer.innerHTML += `
                            <div class="bg-zen-sand p-4 rounded-xl shadow-md flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                                <img src="${data.image_url}" alt="${data.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-300">
                                <div class="flex-grow text-center sm:text-left">
                                    <h3 class="text-xl font-semibold">${data.name}</h3>
                                    <p class="text-sm text-gray-600 mb-1">${data.description}</p>
                                    <p class="text-2xl text-zen-gold font-bold">Â¥${data.price.toFixed(2)}</p>
                                </div>
                                <button onclick="simulatePurchase('${data.name}', ${data.price})" class="px-4 py-2 bg-zen-ink text-white font-medium rounded-lg hover:bg-zen-ink/90 transition-colors w-full sm:w-auto">
                                    ${t['store-buy-button']}
                                </button>
                            </div>
                        `;
                    }
                });

                if (itemsCount === 0) {
                    itemsContainer.innerHTML = `<div class="text-center text-gray-400 p-8 col-span-full">${t['store-no-items']}</div>`;
                }
            }, (error) => {
                console.error("Error listening to store items:", error);
                const itemsContainer = document.getElementById('store-items');
                if (itemsContainer) itemsContainer.innerHTML = `<div class="text-center text-red-500 p-8 col-span-full">åŠ è½½å•†å“å¤±è´¥ã€‚</div>`;
            });
        }

        window.simulatePurchase = function(itemName, itemPrice) {
            // è¿™æ˜¯æ¨¡æ‹Ÿçš„è´­ä¹°åŠŸèƒ½ï¼Œå®é™…éœ€è¦é›†æˆæ”¯ä»˜ç½‘å…³
            console.log(`Simulated purchase initiated: ${itemName} for Â¥${itemPrice}`);
            showCustomMessage(`${translations[currentLanguage]['store-purchase-success']}`, 'success');
        }

        // --- Feature 4: Buzhou Mountain (Firestore Enabled) ---
        function showBuzhou(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const contentHtml = `
                <div id="buzhou-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div id="buzhou-articles" class="flex-grow space-y-6 p-2 mb-4 overflow-y-auto">
                        <div class="text-center text-gray-400 p-8" id="buzhou-loading">æ­£åœ¨åŠ è½½å¥‡äººå¼‚å¿—...</div>
                    </div>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();

            const buzhouRef = collection(window.db, `artifacts/${appId}/public/data/buzhou_content`);
            const q = query(buzhouRef, orderBy("createdAt", "desc"));

            // å®æ—¶ç›‘å¬ Buzhou å†…å®¹
            onSnapshot(q, (snapshot) => {
                const articlesContainer = document.getElementById('buzhou-articles');
                if (!articlesContainer) return;
                
                articlesContainer.innerHTML = '';
                let contentCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.title && data.content) { 
                        contentCount++;
                        const timestamp = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US') : 'æœªçŸ¥æ—¶é—´';
                        
                        articlesContainer.innerHTML += `
                            <div class="p-6 bg-zen-sand rounded-xl shadow-lg">
                                <h3 class="text-2xl font-bold text-zen-ink mb-2">${data.title}</h3>
                                <p class="text-sm text-zen-gold mb-3">ä½œè€…: ${data.author || 'åŒ¿å'} | ${timestamp}</p>
                                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${data.content}</p>
                            </div>
                        `;
                    }
                });

                if (contentCount === 0) {
                    articlesContainer.innerHTML = `<div class="text-center text-gray-400 p-8">${t['buzhou-no-content']}</div>`;
                }
            }, (error) => {
                console.error("Error listening to Buzhou content:", error);
                const articlesContainer = document.getElementById('buzhou-articles');
                if (articlesContainer) articlesContainer.innerHTML = `<div class="text-center text-red-500 p-8">åŠ è½½å†…å®¹å¤±è´¥ã€‚</div>`;
            });
        }
        
        // --- Event Listeners (Remain the same) ---
        document.addEventListener('click', (e) => {
            const overlay = document.getElementById('overlay-container');
            if (overlay.classList.contains('active') && e.target === overlay) {
                hideOverlay();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('overlay-container').classList.contains('active')) {
                hideOverlay();
            }
        });
        
        // --- Main App Logic and Initialization ---
        const initialQuoteEl = document.getElementById('initial-quote');
        document.addEventListener('DOMContentLoaded', async () => {
            const lang = await setInitialQuote(); 
            updateUIForLanguage(lang);
        });
    </script>
    
    <!-- ç”¨æˆ·IDæ˜¾ç¤ºåŒºåŸŸ (Firebase Auth Status) -->
    <div class="fixed top-2 right-4 text-xs text-gray-400 z-50">
        <span id="user-id-label">ä¼šè¯ç¼–å·</span>: <span id="user-id-display">Connecting...</span>
    </div>

    <!-- ä¸»ç”»å¸ƒåŒºåŸŸ (Main Canvas) -->
    <div id="main-canvas" class="min-h-screen flex flex-col justify-center items-center p-8 transition-all duration-700">
        
        <!-- é¡¶éƒ¨å¼•å¯¼è¯­å’Œåˆ†äº«æŒ‰é’® -->
        <div class="text-center mb-16 max-w-4xl w-full">
            <div id="initial-quote" class="text-center mb-8"></div>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="copyQuote()" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:bg-zen-gold/90 transition-all duration-300 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.977l-1.571 1.571A5 5 0 0118 10a5 5 0 01-4.757 4.908l1.571-1.571A3 3 0 1015 8zM5.5 10a.5.5 0 000 1h2.5a.5.5 0 000-1H5.5z" /><path fill-rule="evenodd" d="M3 10a7 7 0 1114 0 7 7 0 01-14 0zm8-4a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" /></svg>
                    <span id="share-button-text">å°†æ­¤æ™ºæ…§é€ç»™æœ‹å‹</span>
                </button>
            </div>
        </div>

        <!-- å››ä¸ªå²›å±¿åŒºåŸŸ (Islands) -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl w-full mt-12">
            
            <!-- å²›å±¿ 1: AI ç®¡å®¶ -->
            <div id="island-ai" onclick="showIslandOverlay('ai', 'ai-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">ğŸ§˜</span>
                <h3 id="island-ai-title" class="text-xl font-semibold">AI ç®¡å®¶</h3>
                <p id="island-ai-subtitle" class="text-sm text-gray-600">â€” æ™ºæ…§é—®è¯¢ â€”</p>
            </div>

            <!-- å²›å±¿ 2: è®¸æ„¿å±± -->
            <div id="island-wish" onclick="showIslandOverlay('wish', 'wish-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">â›°ï¸</span>
                <h3 id="island-wish-title" class="text-xl font-semibold">è®¸æ„¿å±±</h3>
                <p id="island-wish-subtitle" class="text-sm text-gray-600">â€” å€¾å¬ä¼—ç”Ÿ â€”</p>
            </div>

            <!-- å²›å±¿ 3: å•†åº— -->
            <div id="island-store" onclick="showIslandOverlay('store', 'store-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">ğŸ›ï¸</span>
                <h3 id="island-store-title" class="text-xl font-semibold">æ³•ç‰©æµé€š</h3>
                <p id="island-store-subtitle" class="text-sm text-gray-600">â€” é»„çº¸ä¾›å…» â€”</p>
            </div>

            <!-- å²›å±¿ 4: ä¸å‘¨å±± -->
            <div id="island-buzhou" onclick="showIslandOverlay('buzhou', 'buzhou-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">âœ¨</span>
                <h3 id="island-buzhou-title" class="text-xl font-semibold">ä¸å‘¨å±±</h3>
                <p id="island-buzhou-subtitle" class="text-sm text-gray-600">â€” å¥‡äººå¼‚å¿— â€”</p>
            </div>
        </div>
    </div>

    <!-- ç»Ÿä¸€çš„æ”¾å¤§åŒºåŸŸ/æµ®çª—å®¹å™¨ (Overlays Container) -->
    <div id="overlay-container" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <!-- Overlay Content will be dynamically injected here -->
    </div>

</body>
</html>
