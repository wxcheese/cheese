<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wxCheese - Where your smile grows and travels far</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥æ€æºå®‹ä½“ï¼Œå¢å¼ºç¦…æ„ç¾å­¦ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ç¦…æ„é…è‰²æ–¹æ¡ˆ */
            --zen-gold: #9E7B5B; /* æŸ”å’Œçš„ç ‚é‡‘ */
            --zen-sand: #FBF9F6; /* æ¥è¿‘çº¯ç™½çš„èƒŒæ™¯ */
            --zen-ink: #333333; /* æ·±å¢¨è‰² */
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--zen-sand); /* çº¯ç™½èƒŒæ™¯ */
            color: var(--zen-ink);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* ç¡®ä¿çº¯å‡€çš„ç”»å¸ƒæ•ˆæœ */
        }
        /* æ ¸å¿ƒå±…ä¸­å®¹å™¨ */
        .wisdom-container {
            max-width: 80%;
            text-align: center;
            padding: 20px;
        }
        /* åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 1.2s ease-out forwards; /* åŠ¨ç”»æ›´æ…¢ã€æ›´å¹³æ»‘ */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #wisdom-quote {
            cursor: pointer; /* æç¤ºç”¨æˆ·å¯ä»¥äº¤äº’ */
            transition: color 0.3s ease;
        }
        #wisdom-quote:hover {
            color: var(--zen-gold);
        }
        #explanation {
            min-height: 50px; /* ä¿æŒå¸ƒå±€ç¨³å®š */
            transition: opacity 0.5s ease;
        }
    </style>
    
    <!-- æ ¸å¿ƒ JavaScript é€»è¾‘ï¼šæ ¼è¨€è·å–ã€ä¸€æœŸä¸€ä¼šç¼–å· -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // å¼•å…¥äº‹åŠ¡ (runTransaction) æ¥ç¡®ä¿è®¡æ•°å™¨å‡†ç¡®æ€§
        import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Configuration ---
        const GEMINI_API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        const GEMINI_API_KEY = ""; // Canvas will provide key at runtime
        
        const COUNTER_PATH = "artifacts/global/counters/visitor_count";
        const VISITOR_COLLECTION = "artifacts/global/visitors";

        let db;
        let auth;
        let isCounterInitialized = false; // æ ‡è®°æ˜¯å¦å·²å°è¯•è·å–ç¼–å·

        // ----------------------------------------------------
        // ** ğŸš¨ REAL FIREBASE CONFIGURATION AREA for the counter ğŸš¨ **
        // ----------------------------------------------------
        // When deploying to Vercel, ensure this object contains your actual keys.
        const REAL_FIREBASE_CONFIG = {
          apiKey: "AIzaSyC5yS2OFfbhX7qA37CJGMMtWNYu96RYM",
          authDomain: "semiotic-sylph-418318.firebaseapp.com",
          projectId: "semiotic-sylph-418318",
          storageBucket: "semiotic-sylph-418318.appspot.com",
          messagingSenderId: "788592797598",
          appId: "1:788592797598:web:fcbc0f2b38d4c365e2ff67"
        };
        // ----------------------------------------------------


        /**
         * Fetch function with exponential backoff for resilience.
         */
        async function fetchWithRetry(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url + GEMINI_API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 400 || response.status === 401) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * Initializes the Firebase application and authentication.
         */
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig = null;

                // Priority: Canvas config (for debugging), then REAL_FIREBASE_CONFIG (for deployment)
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (REAL_FIREBASE_CONFIG && REAL_FIREBASE_CONFIG.projectId) {
                    firebaseConfig = REAL_FIREBASE_CONFIG;
                }

                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing or invalid.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user && !isCounterInitialized) { // ä»…åœ¨æœªåˆå§‹åŒ–æ—¶è¿è¡Œ
                        isCounterInitialized = true;
                        const userId = user.uid;
                        await initializeCounter(appId, userId); // Initialize and fetch serial number
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
            }
        }
        
        /**
         * ä½¿ç”¨ Firestore äº‹åŠ¡ç¡®ä¿è®¿é—®ç¼–å·çš„å”¯ä¸€æ€§å’Œç´¯ç§¯æ€§ã€‚
         */
        async function initializeCounter(appId, uid) {
            try {
                const counterRef = doc(db, COUNTER_PATH);
                const visitorRef = doc(db, VISITOR_COLLECTION, uid);
                const counterElement = document.getElementById('user-counter');

                let currentNumber;
                let visitorDoc = await getDoc(visitorRef);

                // æ£€æŸ¥è®¿å®¢æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—® (åŸºäºæ˜¯å¦å­˜åœ¨è®°å½•)
                if (!visitorDoc.exists()) {
                    
                    // é¦–æ¬¡è®¿é—®ï¼šä½¿ç”¨äº‹åŠ¡é€’å¢å…¨å±€è®¡æ•°å™¨
                    currentNumber = await runTransaction(db, async (transaction) => {
                        const snap = await transaction.get(counterRef);
                        let newCount = snap.exists() ? snap.data().value + 1 : 1;
                        
                        transaction.set(counterRef, { value: newCount });
                        transaction.set(visitorRef, { userId: uid, lastVisit: Date.now(), serial: newCount });
                        
                        return newCount;
                    });
                    
                } else {
                    // é‡å¤è®¿å®¢ï¼šè¯»å–ä»–ä»¬å·²åˆ†é…çš„ç¼–å·
                    currentNumber = visitorDoc.data().serial || (visitorDoc.data().lastVisit % 10000 + 1); 
                    // ç¡®ä¿æ›´æ–°è®¿é—®æ—¶é—´
                    await setDoc(visitorRef, { lastVisit: Date.now() }, { merge: true });
                }

                counterElement.textContent = `#${currentNumber}`;
                
            } catch (e) {
                console.error("Error initializing counter:", e);
                const counterElement = document.getElementById('user-counter');
                if (counterElement) {
                    counterElement.textContent = '#Error';
                }
            }
        }


        /**
         * Fetches the initial Zen quote (now fixed to English).
         * ç¨³å®šæ˜¾ç¤ºæ ¼è¨€ï¼Œåªåœ¨è·å–åˆ°æ–°å†…å®¹åæ›´æ–°ã€‚
         */
        async function fetchInitialWisdom() {
            const quoteElement = document.getElementById('wisdom-quote');
            const targetLang = 'English';
            
            // ç³»ç»Ÿæç¤ºç¡®ä¿å†…å®¹ç®€æ´ä¸”å›ºå®šä¸ºè‹±æ–‡
            const systemPrompt = `You are a supremely wise Zen master. Provide a concise, profound ${targetLang} phrase or sentence for guidance and introspection for the day. The quote MUST NOT be longer than 20 characters (including spaces). Do not include any punctuation, sources, or quotation marks.`;
            const userQuery = "Give me a maxim about the present moment or minimalism.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const result = await fetchWithRetry(GEMINI_API_URL_TEXT, payload);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 
                             "The present moment is your final master"; // English fallback
                
                // ä»…åœ¨è·å–åˆ°æ–‡æœ¬åè®¾ç½®å†…å®¹å¹¶è§¦å‘æ·¡å…¥åŠ¨ç”»
                quoteElement.textContent = text.trim();
                quoteElement.classList.add('fade-in');
                
            } catch (e) {
                console.error("Error fetching wisdom quote:", e);
                quoteElement.textContent = "The present moment is your final master"; // English fallback
                quoteElement.classList.add('fade-in'); 
            }
        }

        /**
         * âœ¨ Gemini API Function: Provides a deeper, multi-paragraph explanation of the current quote.
         */
        async function explainQuote() {
            const quote = document.getElementById('wisdom-quote').textContent;
            const explanationEl = document.getElementById('explanation');
            
            if (explanationEl.dataset.loading === 'true') return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å†…å®¹ï¼Œæœ‰åˆ™éšè—
            if (explanationEl.textContent && explanationEl.textContent.startsWith('âœ¨ Deepening') === false) {
                 explanationEl.textContent = '';
                 return;
            }

            // Show loading state
            explanationEl.textContent = 'âœ¨ Deepening the contemplation...';
            explanationEl.classList.remove('text-zen-ink', 'fade-in');
            explanationEl.classList.add('text-zen-gold', 'animate-pulse');
            explanationEl.dataset.loading = 'true';
            
            const systemPrompt = "You are a profound Buddhist scholar and writer. Your task is to provide a detailed, concise (no more than 4 sentences) philosophical explanation of the user's provided Zen maxim. The explanation must be in clear, eloquent English, focusing on its meaning for modern life.";
            const userQuery = `Elaborate on the Zen maxim: "${quote}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(GEMINI_API_URL_TEXT, payload);
                const explanationText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "The depth of the void requires no explanation.";
                
                explanationEl.textContent = explanationText.trim();
                explanationEl.classList.remove('animate-pulse');
                explanationEl.classList.add('fade-in', 'text-zen-ink');

            } catch (e) {
                console.error("Error fetching explanation:", e);
                explanationEl.textContent = "Silence is the answer. (API Error)";
            } finally {
                explanationEl.dataset.loading = 'false';
                explanationEl.classList.remove('text-zen-gold');
            }
        }
        
        // Launch application upon window load
        window.onload = function() {
             initializeFirebase(); 
             fetchInitialWisdom();
             
             // Setup double-click listener on the quote element
             const quoteElement = document.getElementById('wisdom-quote');
             // ä¿®æ­£ï¼šç°åœ¨åŒå‡»ä¼šè§¦å‘è§£é‡Š/éšè—äº¤æ›¿
             quoteElement.addEventListener('dblclick', explainQuote);
        };

    </script>
</head>
<body>

    <!-- Top Bar: Serial Number -->
    <header class="fixed top-4 right-4 z-10 p-4">
        <div class="text-right flex flex-col items-end">
            <!-- Serial number only -->
            <p id="user-counter" class="text-xl font-extrabold text-zen-gold">#Loading</p>
        </div>
    </header>

    <!-- Main Canvas Content: Pure Quote and Explanation -->
    <div class="wisdom-container">
        <!-- Main Quote -->
        <h1 id="wisdom-quote" class="text-4xl md:text-6xl font-bold text-zen-ink opacity-0 transition-opacity">
            Contemplating...
        </h1>
        
        <!-- Hidden/Secondary AI Explanation -->
        <p id="explanation" class="text-lg md:text-xl text-zen-ink mt-8 max-w-2xl mx-auto"></p>
        
        <p class="text-xs text-gray-400 mt-4">â€” Double-click the maxim to unveil its deeper meaning â€”</p>
    </div>
    
    <!-- Footer: Alert Message Container (Necessary placeholder) -->
    <div id="alert-container" class="fixed bottom-4 right-4 z-50 flex flex-col items-end pointer-events-none">
        <!-- Alerts will appear here -->
    </div>

</body>
</html>
