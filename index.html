<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wxCheese - Where your smile grows and travels far</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入思源宋体，增强禅意美学 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 禅意配色方案 */
            --zen-gold: #9E7B5B; /* 柔和的砂金 */
            --zen-sand: #FBF9F6; /* 接近纯白的背景 */
            --zen-ink: #333333; /* 深墨色 */
        }
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--zen-sand); /* 纯白背景 */
            color: var(--zen-ink);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* 确保纯净的画布效果 */
        }
        /* 核心居中容器 */
        .wisdom-container {
            max-width: 80%;
            text-align: center;
            padding: 20px;
        }
        /* 动画 */
        .fade-in {
            animation: fadeIn 1.2s ease-out forwards; /* 动画更慢、更平滑 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #wisdom-quote {
            cursor: pointer; /* 提示用户可以交互 */
            transition: color 0.3s ease;
        }
        #wisdom-quote:hover {
            color: var(--zen-gold);
        }
        #explanation {
            min-height: 50px; /* 保持布局稳定 */
            transition: opacity 0.5s ease;
        }
    </style>
    
    <!-- 核心 JavaScript 逻辑：格言获取、一期一会编号 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // 引入事务 (runTransaction) 来确保计数器准确性
        import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Configuration ---
        const GEMINI_API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        const GEMINI_API_KEY = ""; // Canvas will provide key at runtime
        
        const COUNTER_PATH = "artifacts/global/counters/visitor_count";
        const VISITOR_COLLECTION = "artifacts/global/visitors";

        let db;
        let auth;
        let isCounterInitialized = false; // 标记是否已尝试获取编号

        // ----------------------------------------------------
        // ** 🚨 REAL FIREBASE CONFIGURATION AREA for the counter 🚨 **
        // ----------------------------------------------------
        // When deploying to Vercel, ensure this object contains your actual keys.
        const REAL_FIREBASE_CONFIG = {
          apiKey: "AIzaSyC5yS2OFfbhX7qA37CJGMMtWNYu96RYM",
          authDomain: "semiotic-sylph-418318.firebaseapp.com",
          projectId: "semiotic-sylph-418318",
          storageBucket: "semiotic-sylph-418318.appspot.com",
          messagingSenderId: "788592797598",
          appId: "1:788592797598:web:fcbc0f2b38d4c365e2ff67"
        };
        // ----------------------------------------------------


        /**
         * Fetch function with exponential backoff for resilience.
         */
        async function fetchWithRetry(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url + GEMINI_API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 400 || response.status === 401) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * Initializes the Firebase application and authentication.
         */
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig = null;

                // Priority: Canvas config (for debugging), then REAL_FIREBASE_CONFIG (for deployment)
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (REAL_FIREBASE_CONFIG && REAL_FIREBASE_CONFIG.projectId) {
                    firebaseConfig = REAL_FIREBASE_CONFIG;
                }

                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing or invalid.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user && !isCounterInitialized) { // 仅在未初始化时运行
                        isCounterInitialized = true;
                        const userId = user.uid;
                        await initializeCounter(appId, userId); // Initialize and fetch serial number
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
            }
        }
        
        /**
         * 使用 Firestore 事务确保访问编号的唯一性和累积性。
         */
        async function initializeCounter(appId, uid) {
            try {
                const counterRef = doc(db, COUNTER_PATH);
                const visitorRef = doc(db, VISITOR_COLLECTION, uid);
                const counterElement = document.getElementById('user-counter');

                let currentNumber;
                let visitorDoc = await getDoc(visitorRef);

                // 检查访客是否是首次访问 (基于是否存在记录)
                if (!visitorDoc.exists()) {
                    
                    // 首次访问：使用事务递增全局计数器
                    currentNumber = await runTransaction(db, async (transaction) => {
                        const snap = await transaction.get(counterRef);
                        let newCount = snap.exists() ? snap.data().value + 1 : 1;
                        
                        transaction.set(counterRef, { value: newCount });
                        transaction.set(visitorRef, { userId: uid, lastVisit: Date.now(), serial: newCount });
                        
                        return newCount;
                    });
                    
                } else {
                    // 重复访客：读取他们已分配的编号
                    currentNumber = visitorDoc.data().serial || (visitorDoc.data().lastVisit % 10000 + 1); 
                    // 确保更新访问时间
                    await setDoc(visitorRef, { lastVisit: Date.now() }, { merge: true });
                }

                counterElement.textContent = `#${currentNumber}`;
                
            } catch (e) {
                console.error("Error initializing counter:", e);
                const counterElement = document.getElementById('user-counter');
                if (counterElement) {
                    counterElement.textContent = '#Error';
                }
            }
        }


        /**
         * Fetches the initial Zen quote (now fixed to English).
         * 稳定显示格言，只在获取到新内容后更新。
         */
        async function fetchInitialWisdom() {
            const quoteElement = document.getElementById('wisdom-quote');
            const targetLang = 'English';
            
            // 系统提示确保内容简洁且固定为英文
            const systemPrompt = `You are a supremely wise Zen master. Provide a concise, profound ${targetLang} phrase or sentence for guidance and introspection for the day. The quote MUST NOT be longer than 20 characters (including spaces). Do not include any punctuation, sources, or quotation marks.`;
            const userQuery = "Give me a maxim about the present moment or minimalism.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const result = await fetchWithRetry(GEMINI_API_URL_TEXT, payload);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 
                             "The present moment is your final master"; // English fallback
                
                // 仅在获取到文本后设置内容并触发淡入动画
                quoteElement.textContent = text.trim();
                quoteElement.classList.add('fade-in');
                
            } catch (e) {
                console.error("Error fetching wisdom quote:", e);
                quoteElement.textContent = "The present moment is your final master"; // English fallback
                quoteElement.classList.add('fade-in'); 
            }
        }

        /**
         * ✨ Gemini API Function: Provides a deeper, multi-paragraph explanation of the current quote.
         */
        async function explainQuote() {
            const quote = document.getElementById('wisdom-quote').textContent;
            const explanationEl = document.getElementById('explanation');
            
            if (explanationEl.dataset.loading === 'true') return;

            // 检查是否已经有内容，有则隐藏
            if (explanationEl.textContent && explanationEl.textContent.startsWith('✨ Deepening') === false) {
                 explanationEl.textContent = '';
                 return;
            }

            // Show loading state
            explanationEl.textContent = '✨ Deepening the contemplation...';
            explanationEl.classList.remove('text-zen-ink', 'fade-in');
            explanationEl.classList.add('text-zen-gold', 'animate-pulse');
            explanationEl.dataset.loading = 'true';
            
            const systemPrompt = "You are a profound Buddhist scholar and writer. Your task is to provide a detailed, concise (no more than 4 sentences) philosophical explanation of the user's provided Zen maxim. The explanation must be in clear, eloquent English, focusing on its meaning for modern life.";
            const userQuery = `Elaborate on the Zen maxim: "${quote}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(GEMINI_API_URL_TEXT, payload);
                const explanationText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "The depth of the void requires no explanation.";
                
                explanationEl.textContent = explanationText.trim();
                explanationEl.classList.remove('animate-pulse');
                explanationEl.classList.add('fade-in', 'text-zen-ink');

            } catch (e) {
                console.error("Error fetching explanation:", e);
                explanationEl.textContent = "Silence is the answer. (API Error)";
            } finally {
                explanationEl.dataset.loading = 'false';
                explanationEl.classList.remove('text-zen-gold');
            }
        }
        
        // Launch application upon window load
        window.onload = function() {
             initializeFirebase(); 
             fetchInitialWisdom();
             
             // Setup double-click listener on the quote element
             const quoteElement = document.getElementById('wisdom-quote');
             // 修正：现在双击会触发解释/隐藏交替
             quoteElement.addEventListener('dblclick', explainQuote);
        };

    </script>
</head>
<body>

    <!-- Top Bar: Serial Number -->
    <header class="fixed top-4 right-4 z-10 p-4">
        <div class="text-right flex flex-col items-end">
            <!-- Serial number only -->
            <p id="user-counter" class="text-xl font-extrabold text-zen-gold">#Loading</p>
        </div>
    </header>

    <!-- Main Canvas Content: Pure Quote and Explanation -->
    <div class="wisdom-container">
        <!-- Main Quote -->
        <h1 id="wisdom-quote" class="text-4xl md:text-6xl font-bold text-zen-ink opacity-0 transition-opacity">
            Contemplating...
        </h1>
        
        <!-- Hidden/Secondary AI Explanation -->
        <p id="explanation" class="text-lg md:text-xl text-zen-ink mt-8 max-w-2xl mx-auto"></p>
        
        <p class="text-xs text-gray-400 mt-4">— Double-click the maxim to unveil its deeper meaning —</p>
    </div>
    
    <!-- Footer: Alert Message Container (Necessary placeholder) -->
    <div id="alert-container" class="fixed bottom-4 right-4 z-50 flex flex-col items-end pointer-events-none">
        <!-- Alerts will appear here -->
    </div>

</body>
</html>
