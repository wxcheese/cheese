<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- UPDATED: New Website Title -->
    <title>wxCheese – Where your smile grows and travels far</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    },
                    colors: {
                        'zen-white': '#FDFDFD',
                        'zen-sand': '#EFEBE9',
                        'zen-gold': '#DAA520',
                        'zen-ink': '#333333',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            overflow: hidden; /* 防止主页面滚动 */
            background-color: #FDFDFD;
            min-height: 100vh;
        }

        /* 模拟画布和岛屿的过渡效果 */
        .island-card {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .island-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* 放大进入（Modal/Overlay）效果 */
        .zoom-overlay {
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
            visibility: hidden;
            opacity: 0;
            z-index: 50;
        }
        .zoom-overlay.active {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans text-zen-ink">

    <!-- Firebase and Google API Dependencies -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, orderBy, addDoc, serverTimestamp, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug'); // Enable Firestore logging

        // --- Global Firebase and API Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'zen-canvas-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const AI_MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent`;
        const API_KEY = ""; // Canvas provides this dynamically

        let db = null;
        let auth = null;
        let userId = null; // This will hold the internal Firebase UID/Anonymous ID
        let currentLanguage = 'zh'; // Default language

        // --- Core Firebase Initialization and Authentication ---

        /**
         * Reads, increments, and updates the global session counter in Firestore.
         * @param {object} dbInstance Firestore instance.
         * @param {string} currentUserId The internal Firebase user ID.
         */
        const updateSessionCounter = async (dbInstance, currentUserId) => {
            const counterPath = `artifacts/${appId}/public/data/metadata`;
            const counterDocRef = doc(dbInstance, counterPath, 'global_session_counter');

            try {
                // 1. Read the current count
                const docSnap = await getDoc(counterDocRef);
                let currentCount = 0;
                
                if (docSnap.exists()) {
                    currentCount = docSnap.data().count || 0;
                }

                const newCount = currentCount + 1;
                
                // 2. Update the document with the new count (simple increment)
                await setDoc(counterDocRef, {
                    count: newCount,
                    lastSessionUserId: currentUserId,
                    lastSessionTime: serverTimestamp()
                }, { merge: false });

                // 3. Update display to show the sequential session number (一期一会)
                const displayId = `#${newCount}`;
                document.getElementById('user-id-display').textContent = displayId;
                
                // Return the sequential count for use in other functions (like adding a wish)
                return displayId; 

            } catch (error) {
                console.error("Failed to update global session counter:", error);
                // Fallback display if counter fails
                document.getElementById('user-id-display').textContent = 'ID Error';
                return currentUserId.substring(0, 8); // Fallback to a shortened Firebase ID
            }
        };


        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // IMPORTANT: The session ID logic is moved inside the auth state change listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // Internal Firebase ID
                        console.log("Auth State Changed. User ID (Internal):", userId);
                    } else {
                        // Use a fallback UUID if auth fails (shouldn't happen in canvas)
                        userId = crypto.randomUUID();
                        console.log("User signed out or authentication failed. Using fallback ID (Internal).");
                    }
                    
                    // 1. Update the Global Session Counter (一期一会)
                    const sessionNumber = await updateSessionCounter(db, userId);

                    // 2. Once authenticated and session number is retrieved, start the Wish Mountain listener
                    setupWishMountainListener(db, sessionNumber);
                });

            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
            }
        };

        // --- Multi-Language Translation Map ---
        const translations = {
            'zh': {
                // Main Islands
                'island-ai-title': 'AI 管家',
                'island-ai-subtitle': '— 智慧问询 —',
                'island-wish-title': '许愿山',
                'island-wish-subtitle': '— 倾听众生 —',
                'island-store-title': '法物流通',
                'island-store-subtitle': '— 黄纸供养 —',
                'island-buzhou-title': '不周山',
                'island-buzhou-subtitle': '— 奇人异志 —',
                'share-button': '将此智慧送给朋友',
                'user-id-label': '本期编号', // NEW LABEL
                
                // Overlays
                'ai-overlay-title': 'AI 管家: 禅定问答',
                'ai-input-placeholder': '输入您心中的困惑...',
                'ai-submit-btn': '提问',
                'ai-status': 'AI大师思考中...',
                'ai-initial-greeting': "欢迎来到禅意画布。吾乃此地AI管家，可为您答疑解惑。请问您心中有何困惑或向往？",
                
                'wish-overlay-title': '许愿山: 众生心愿',
                'wish-list-loading': '加载中... 请稍候片刻，或许下您的心愿。',
                'wish-input-placeholder': '留下您的心愿、困惑或祝福 (不超过100字)...',
                'wish-submit-btn': '发送你的愿望',
                'wish-loading-status': '许愿中...',
                'wish-refine-btn': '✨ 愿力提炼',
                'wish-refining': '正在提炼愿力...',

                // Store
                'store-overlay-title': '法物流通: 许愿材料',
                'store-item-title': '高品质许愿黄纸',
                'store-item-desc': '精选上等黄纸，用于书写心愿，心诚则灵。',
                'store-item-price': '￥9.99 / 10张',
                'store-mock-desc': '此为模拟交易界面，旨在表达心意。',
                'store-mock-btn': '立即结缘 (模拟购买)',

                // Buzhou
                'buzhou-overlay-title': '不周山: 奇人异士录',
                'buzhou-story-1-title': '【首位记录者】山中老僧：无名之境',
                'buzhou-story-1-content': '老僧在不周山闭关三十载，未曾开口言语。他只留下一幅字：“放下”——两个字，道尽世间万般法。他的故事不是关于修行，而是关于存在本身。留待您日后发现更多影像与文字。',
                'buzhou-story-2-title': '【待续】云游道人：以梦入道',
                'buzhou-story-2-content': '此处将记录一位能够进入他人梦境，以佛法点化迷津的云游道人的故事。他居无定所，行踪不定，唯有心诚者，方能在梦中相遇。敬请期待您未来亲自上传的奇人异士事迹。',
                'buzhou-sketch-title': '✨ 奇人速写创作',
                'buzhou-sketch-placeholder': '描述一位奇人异士 (例如: 一个会飞的卖豆腐的道士)...',
                'buzhou-sketch-btn': '创作奇人录',
                'buzhou-sketching': '正在撰写传奇...',
            },
            'en': {
                // Main Islands
                'island-ai-title': 'AI Butler',
                'island-ai-subtitle': '— Ask Me —',
                'island-wish-title': 'Wish Mountain',
                'island-wish-subtitle': '— Make a Wish —',
                'island-store-title': 'Store',
                'island-store-subtitle': '— Offerings —',
                'island-buzhou-title': 'Buzhou Mountain',
                'island-buzhou-subtitle': '— Tales of the Wise —',
                'share-button': 'Share This Wisdom',
                'user-id-label': 'Session No.', // NEW LABEL
                
                // Overlays
                'ai-overlay-title': 'AI Butler: Zen Dialogue',
                'ai-input-placeholder': 'Type your question or concern...',
                'ai-submit-btn': 'Ask',
                'ai-status': 'AI Master is meditating...',
                'ai-initial-greeting': "Welcome to the Zen Canvas. I am the AI Butler, here to answer your questions. What burdens your heart or what do you aspire to?",
                
                'wish-overlay-title': 'Wish Mountain: Wishes of Beings',
                'wish-list-loading': 'Loading wishes... Please wait or make your own wish.',
                'wish-input-placeholder': 'Leave your wish, concern, or blessing (max 100 characters)...',
                'wish-submit-btn': 'Send Your Wish',
                'wish-loading-status': 'Wishing in progress...',
                'wish-refine-btn': '✨ Refine Wish Power',
                'wish-refining': 'Refining wish power...',

                // Store
                'store-overlay-title': 'Store: Offering Materials',
                'store-item-title': 'High-Quality Yellow Paper',
                'store-item-desc': 'Finely selected paper for writing wishes. Sincerity brings forth results.',
                'store-item-price': '$9.99 / 10 Sheets',
                'store-mock-desc': 'This is a simulated transaction interface, intended to express intent.',
                'store-mock-btn': 'Acquire Immediately (Simulated)',

                // Buzhou
                'buzhou-overlay-title': 'Buzhou Mountain: Chronicle of the Extraordinary',
                'buzhou-story-1-title': '【First Recorded】The Old Monk: State of No-Name',
                'buzhou-story-1-content': 'The old monk meditated in Buzhou Mountain for thirty years without uttering a word. He only left one calligraphy scroll: "Let Go"—two words that express the entirety of worldly Dharma. His story is not about practice, but about existence itself. More images and texts await your future discovery.',
                'buzhou-story-2-title': '【To be Continued】Wandering Taoist: Entering the Path through Dreams',
                'buzhou-story-2-content': 'This records the story of a wandering Taoist who can enter others\' dreams and enlighten the lost with Dharma. He has no fixed dwelling, and his whereabouts are unknown. Only the truly sincere may encounter him in their dreams. Look forward to future tales of extraordinary individuals uploaded by you.',
                'buzhou-sketch-title': '✨ Extraordinary Person Sketch',
                'buzhou-sketch-placeholder': 'Describe an extraordinary person (e.g., a flying tofu seller Taoist)...',
                'buzhou-sketch-btn': 'Create Sketch',
                'buzhou-sketching': 'Writing the legend...',
            }
        };

        /**
         * Updates all static UI elements based on the detected language.
         * @param {string} lang 'zh' or 'en'.
         */
        const updateUIForLanguage = (lang) => {
            const t = translations[lang] || translations['en']; 

            // Update HTML lang attribute
            document.documentElement.lang = lang;

            // 1. Main Islands
            document.getElementById('island-ai-title').textContent = t['island-ai-title'];
            document.getElementById('island-ai-subtitle').textContent = t['island-ai-subtitle'];
            document.getElementById('island-wish-title').textContent = t['island-wish-title'];
            document.getElementById('island-wish-subtitle').textContent = t['island-wish-subtitle'];
            document.getElementById('island-store-title').textContent = t['island-store-title'];
            document.getElementById('island-store-subtitle').textContent = t['island-store-subtitle'];
            document.getElementById('island-buzhou-title').textContent = t['island-buzhou-title'];
            document.getElementById('island-buzhou-subtitle').textContent = t['island-buzhou-subtitle'];
            
            // 2. Share Button
            document.getElementById('share-button-text').innerHTML = t['share-button'];
            
            // 3. User ID Label
            document.getElementById('user-id-label').textContent = t['user-id-label'];

            // 4. AI Overlay
            document.getElementById('ai-overlay-title').textContent = t['ai-overlay-title'];
            document.getElementById('ai-input').placeholder = t['ai-input-placeholder'];
            document.getElementById('ai-submit-btn').textContent = t['ai-submit-btn'];
            document.getElementById('ai-status').textContent = t['ai-status'];
            
            // 5. Wish Overlay
            document.getElementById('wish-overlay-title').textContent = t['wish-overlay-title'];
            document.getElementById('wish-list-loading').textContent = t['wish-list-loading'];
            document.getElementById('wish-input').placeholder = t['wish-input-placeholder'];
            document.getElementById('wish-submit-btn').textContent = t['wish-submit-btn'];
            
            // 6. Store Overlay
            document.getElementById('store-overlay-title').textContent = t['store-overlay-title'];
            document.getElementById('store-item-title').textContent = t['store-item-title'];
            document.getElementById('store-item-desc').textContent = t['store-item-desc'];
            document.getElementById('store-item-price').textContent = t['store-item-price'];
            document.getElementById('store-mock-desc').textContent = t['store-mock-desc'];
            document.getElementById('store-mock-btn').textContent = t['store-mock-btn'];

            // 7. Buzhou Overlay
            document.getElementById('buzhou-overlay-title').textContent = t['buzhou-overlay-title'];
            document.getElementById('buzhou-story-1-title').textContent = t['buzhou-story-1-title'];
            document.getElementById('buzhou-story-1-content').textContent = t['buzhou-story-1-content'];
            document.getElementById('buzhou-story-2-title').textContent = t['buzhou-story-2-title'];
            document.getElementById('buzhou-story-2-content').textContent = t['buzhou-story-2-content'];
            document.getElementById('buzhou-sketch-title').textContent = t['buzhou-sketch-title'];
            document.getElementById('buzhou-sketch-input').placeholder = t['buzhou-sketch-placeholder'];
            document.getElementById('buzhou-sketch-btn').textContent = t['buzhou-sketch-btn'];


            // Update main page title (with the new brand name)
            document.title = 'wxCheese – Where your smile grows and travels far';
        };

        // --- Wisdom Quote Data (Fallback) ---
        const chineseQuotes = [
            "心生种种法生，心灭种种法灭。——《华严经》",
            "一切有为法，如梦幻泡影，如露亦如电，应作如是观。——《金刚经》",
            "菩提本无树，明镜亦非台，本来无一物，何处惹尘埃。——六祖慧能",
            "慈悲喜舍，是为四无量心，能除一切烦恼。——佛教语",
            "境随心转，相由心生。一切福田，不离方寸。——佛教语",
            "欲知前世因，今生受者是；欲知来世果，今生作者是。——三世因果经"
        ];
        
        const englishQuotes = [
            "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.——Buddha",
            "The mind is everything. What you think you become.——Buddha",
            "The greatest prayer is patience.——Buddha",
            "Peace comes from within. Do not seek it without.——Buddha",
            "All that we are is the result of what we have thought.——Buddha"
        ];
        
        // --- Random Quote Generation and Display (Language-Aware) ---
        const initialQuoteEl = document.getElementById('initial-quote');

        const INITIAL_QUOTE_SYSTEM_PROMPT = "You are a compassionate and wise Buddhist master. Provide a brief, fortifying, fortune-cookie-style quote based on Buddhist or Zen philosophy. The quote MUST be rendered in the exact target language requested by the user. If the language is not specified, use Chinese. The response MUST only contain the quote and the source, separated by '——'. Example (English): 'Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.——Buddha'";

        /**
         * Uses Gemini API to generate a wisdom quote in the detected language.
         * @param {string} lang - The detected language code ('en' or 'zh').
         * @returns {Promise<string|null>} Generated quote string or null on failure.
         */
        const getInitialWisdomQuote = async (lang) => {
            if (API_KEY === "") {
                console.warn("API Key is missing. Skipping API quote generation.");
                return null; 
            }
            
            console.log("Sending API request for language:", lang); 
            
            const userPrompt = `为我生成一句佛经智慧格言。目标语言是: ${lang}。`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: INITIAL_QUOTE_SYSTEM_PROMPT }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            console.log(`Rate limit hit, retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const quoteText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    console.log("API Raw Response Text:", quoteText);
                    return quoteText;
                } catch (error) {
                    console.error(`Attempt ${attempt + 1}: Gemini API call for quote failed:`, error);
                    if (attempt === maxRetries - 1) {
                        return null; 
                    }
                }
            }
            return null; // Should be unreachable but ensures function returns null if loop finishes
        };

        const setInitialQuote = async () => {
            // Detect user language. Default to 'en' if neither is detected.
            const detectedLangFull = navigator.language || navigator.userLanguage || 'en-US'; 
            const langCode = detectedLangFull.split('-')[0]; 
            const targetLang = (langCode === 'zh' || langCode === 'en') ? langCode : 'en';

            currentLanguage = targetLang; // Set the global language variable

            console.log("Detected language code (forced to zh/en):", targetLang);
            
            const isEnglish = targetLang === 'en';
            const t = translations[targetLang];

            // Show loading placeholder text
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8 text-gray-400 animate-pulse">
                    ${isEnglish ? 'Drawing Wisdom...' : '正在汲取智慧...'}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    Loading...
                </div>
            `;
            
            let quoteText = await getInitialWisdomQuote(targetLang);

            // Fallback logic
            if (!quoteText) {
                console.warn("API quote generation failed or skipped. Using local quote fallback.");
                
                let quoteArray = isEnglish ? englishQuotes : chineseQuotes;
                
                const randomIndex = Math.floor(Math.random() * quoteArray.length);
                quoteText = quoteArray[randomIndex];
            }
            
            const parts = quoteText.split('——');
            const quote = parts[0] || (isEnglish ? 'Inner peace starts with a single thought.' : '心中有爱，世界永恒');
            const source = parts[1] || (isEnglish ? '【Buddhist Wisdom】' : '【佛经智慧】');
            
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8">
                    ${quote}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    ${source}
                </div>
            `;
            
            return targetLang; // Return the determined language
        };

        // --- Wish Mountain (Firestore) Logic ---
        const wishListEl = document.getElementById('wish-list');
        const wishInput = document.getElementById('wish-input');
        const wishSubmitBtn = document.getElementById('wish-submit-btn');
        const wishForm = document.getElementById('wish-form');
        
        /**
         * Sets up the real-time listener for wishes.
         * @param {object} dbInstance Firestore instance.
         * @param {string} currentSessionNumber The session number (e.g., #10).
         */
        const setupWishMountainListener = (dbInstance, currentSessionNumber) => {
            const path = `artifacts/${appId}/public/data/wishes`;
            const q = query(collection(dbInstance, path), orderBy("timestamp", "desc"), limit(20));
            const locale = currentLanguage === 'en' ? 'en-US' : 'zh-CN';

            onSnapshot(q, (snapshot) => {
                const t = translations[currentLanguage];
                wishListEl.innerHTML = ''; 
                let fragment = document.createDocumentFragment();

                if (snapshot.docs.length === 0) {
                    wishListEl.innerHTML = `<div class="text-center text-gray-500 p-4">${t['wish-list-loading']}</div>`;
                }

                snapshot.docs.forEach(docSnapshot => {
                    const wish = docSnapshot.data();
                    const wishId = docSnapshot.id;
                    // Use determined locale for time formatting
                    const time = wish.timestamp ? new Date(wish.timestamp.toDate()).toLocaleString(locale, { 
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit' 
                    }) : (currentLanguage === 'en' ? 'Just now' : '刚刚');
                    
                    // Display refined wish if it exists in the document
                    const refinedText = wish.refinedWish ? `<p class="mt-3 p-3 bg-zen-gold/10 text-zen-ink rounded-lg font-medium border-l-4 border-zen-gold">✨ ${wish.refinedWish}</p>` : '';
                    
                    // Display the stored session number as the public ID
                    const displayId = wish.sessionNumber || 'N/A';


                    const wishElement = document.createElement('div');
                    wishElement.id = `wish-${wishId}`;
                    wishElement.className = "p-4 border-b border-zen-sand last:border-b-0 bg-white/50 backdrop-blur-sm rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col";
                    wishElement.innerHTML = `
                        <p class="text-lg text-zen-ink whitespace-pre-wrap flex-grow">${wish.content}</p>
                        ${refinedText}
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-zen-sand">
                            <button 
                                onclick="refineWish('${encodeURIComponent(wish.content)}', '${wishId}')" 
                                class="wish-refine-btn text-sm px-3 py-1 bg-zen-gold text-white rounded-full hover:bg-zen-gold/90 transition-colors"
                                data-wish-id="${wishId}"
                                ${wish.refinedWish ? 'disabled' : ''}
                            >
                                ${wish.refinedWish ? (currentLanguage === 'en' ? 'Refined' : '已提炼') : t['wish-refine-btn']}
                            </button>
                            <div class="text-xs text-gray-500 text-right">
                                <span>${currentLanguage === 'en' ? 'Wisher Session' : '许愿编号'}: ${displayId}</span> 
                                <span class="block">${time}</span>
                            </div>
                        </div>
                    `;
                    fragment.appendChild(wishElement);
                });
                
                if (snapshot.docs.length > 0) {
                    wishListEl.appendChild(fragment);
                }
            }, (error) => {
                console.error("Error listening to Wish Mountain:", error);
                const errorMessage = currentLanguage === 'en' ? 'Cannot connect to Wish Mountain, please try again later.' : '无法连接到许愿山，请稍后重试。';
                wishListEl.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            });
        };

        wishForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const wishContent = wishInput.value.trim();
            if (!wishContent || !db || !userId) {
                return;
            }

            const t = translations[currentLanguage];
            wishSubmitBtn.disabled = true;
            wishSubmitBtn.textContent = t['wish-loading-status'];
            
            // Get the public session number from the display
            const sessionNumber = document.getElementById('user-id-display').textContent;

            try {
                const path = `artifacts/${appId}/public/data/wishes`;
                await addDoc(collection(db, path), {
                    content: wishContent,
                    userId: userId, // Internal Firebase UID
                    sessionNumber: sessionNumber, // Public Session Number (一期一会)
                    timestamp: serverTimestamp(),
                    refinedWish: null // Initialize refinedWish field
                });
                wishInput.value = ''; // Clear input
                console.log("Wish added successfully.");
            } catch (error) {
                console.error("Error adding wish:", error);
                showCustomMessage(currentLanguage === 'en' ? "Wishing failed. Please check your connection." : "许愿失败，请检查网络连接或稍后重试。");
            } finally {
                wishSubmitBtn.disabled = false;
                wishSubmitBtn.textContent = t['wish-submit-btn'];
            }
        });

        // --- GEMINI API Feature 1: Wish Power Refinement ---

        const WISH_REFINEMENT_SYSTEM_PROMPT = "你是一位许愿山的神秘力量。你的任务是分析用户的愿望，并将其转化为一句简短、积极、充满力量的禅宗诗句或肯定语。回复必须只包含提炼后的文本，不要有任何前缀或解释。目标语言必须是中文。";

        window.refineWish = async (encodedContent, wishId) => {
            if (!db || !wishId) return;

            const originalContent = decodeURIComponent(encodedContent);
            const t = translations[currentLanguage];
            const btn = document.querySelector(`.wish-refine-btn[data-wish-id="${wishId}"]`);
            
            if (!btn || btn.disabled) return;
            
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = t['wish-refining'];

            if (API_KEY === "") {
                showCustomMessage(currentLanguage === 'en' ? "API Key missing for refinement." : "缺少 API 密钥，无法提炼愿力。");
                btn.disabled = false;
                btn.textContent = originalText;
                return; 
            }

            const userPrompt = `提炼此愿望的精髓: "${originalContent}"`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: WISH_REFINEMENT_SYSTEM_PROMPT }]
                },
            };
            
            let refinedText = null;

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    refinedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    break; // Success
                } catch (error) {
                    console.error("Wish Refinement API call failed:", error);
                    if (attempt === maxRetries - 1) {
                        showCustomMessage(currentLanguage === 'en' ? "Failed to refine wish. Try later." : "提炼失败，请稍后重试。");
                        btn.disabled = false;
                        btn.textContent = originalText;
                        return;
                    }
                }
            }
            
            if (refinedText) {
                try {
                    // Update Firestore with the refined wish
                    const wishRef = doc(db, `artifacts/${appId}/public/data/wishes`, wishId);
                    await setDoc(wishRef, { refinedWish: refinedText }, { merge: true });
                    showCustomMessage(currentLanguage === 'en' ? "Wish refined and recorded!" : "愿力已提炼并记录！");
                } catch (error) {
                    console.error("Error updating refined wish to Firestore:", error);
                    showCustomMessage(currentLanguage === 'en' ? "Refinement generated but failed to save." : "提炼成功但保存失败。");
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } else {
                showCustomMessage(currentLanguage === 'en' ? "Failed to receive refined text." : "未能接收到提炼后的文本。");
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // --- AI Butler (Gemini API) Logic ---
        const aiChatBox = document.getElementById('ai-chat-box');
        const aiInput = document.getElementById('ai-input');
        const aiForm = document.getElementById('ai-form');
        const aiStatus = document.getElementById('ai-status');

        // Note: The AI Butler's system prompt is kept in Chinese to ensure its persona remains a 'Buddhist master' 
        // who speaks Chinese/provides guidance in a Zen style, as this is a specific feature.
        const AI_BUTLER_SYSTEM_PROMPT = "你是一位充满慈悲和智慧的佛家大师，以简洁、温和、富有哲理的方式提供人生指导。所有回答必须基于佛法或禅宗的智慧，避免直接的世俗建议，而是引导对方从心性上找到答案。每次回复不超过150字。";
        
        const createMessage = (text, sender) => {
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 rounded-xl max-w-[85%] mb-4 shadow-md ${sender === 'user' ? 'self-end bg-zen-gold/10 text-zen-ink' : 'self-start bg-zen-sand text-zen-ink'}`;
            messageEl.textContent = text;
            aiChatBox.appendChild(messageEl);
            aiChatBox.scrollTop = aiChatBox.scrollHeight;
        };

        const generateAIResponse = async (prompt) => {
            const t = translations[currentLanguage];
            aiStatus.textContent = t['ai-status'];
            aiStatus.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: AI_BUTLER_SYSTEM_PROMPT }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const fallbackText = currentLanguage === 'en' ? "Apologies, the master is in deep retreat and cannot answer right now. Please try again later." : "抱歉，大师此刻正在闭关，请稍后再试。";
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || fallbackText;
                    createMessage(text, 'ai');
                    break; // Success
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (attempt === maxRetries - 1) {
                        const failMessage = currentLanguage === 'en' ? "Connection or API call failed. Check console." : "网络连接或API调用失败，请检查控制台。";
                        createMessage(failMessage, 'ai');
                    }
                }
            }

            aiStatus.classList.add('hidden');
        };

        aiForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userQuery = aiInput.value.trim();
            if (!userQuery) return;

            createMessage(userQuery, 'user');
            aiInput.value = '';
            generateAIResponse(userQuery);
        });

        // --- GEMINI API Feature 2: Extraordinary Person Sketch (Buzhou Mountain) ---
        const buzhouSketchForm = document.getElementById('buzhou-sketch-form');
        const buzhouSketchInput = document.getElementById('buzhou-sketch-input');
        const buzhouSketchBtn = document.getElementById('buzhou-sketch-btn');
        const buzhouSketchResults = document.getElementById('buzhou-sketch-results');

        const BUZHOU_SKETCH_SYSTEM_PROMPT = "你是不周山的奇人异士录撰写者。根据用户提供的简短描述，撰写一篇充满禅意、奇幻或武侠色彩的短篇故事/传记。故事必须引人入胜，篇幅精简（不超过150字），且符合中文语境。";

        const createBuzhouSketch = async (description) => {
            if (API_KEY === "") {
                showCustomMessage(currentLanguage === 'en' ? "API Key missing for sketch creation." : "缺少 API 密钥，无法创作奇人速写。");
                return null;
            }

            const userPrompt = `根据以下描述撰写奇人传记: "${description}"`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: BUZHOU_SKETCH_SYSTEM_PROMPT }]
                },
            };
            
            let sketchText = null;

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    sketchText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return sketchText;
                } catch (error) {
                    console.error("Buzhou Sketch API call failed:", error);
                    if (attempt === maxRetries - 1) {
                        return null;
                    }
                }
            }
            return null;
        }

        buzhouSketchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = buzhouSketchInput.value.trim();
            if (!description) return;

            const t = translations[currentLanguage];
            buzhouSketchBtn.disabled = true;
            const originalText = buzhouSketchBtn.textContent;
            buzhouSketchBtn.textContent = t['buzhou-sketching'];
            
            const sketch = await createBuzhouSketch(description);

            if (sketch) {
                const sketchElement = document.createElement('div');
                sketchElement.className = "p-4 bg-zen-gold/10 rounded-xl shadow-md border-l-4 border-zen-gold animate-in fade-in";
                sketchElement.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">【AI速写】${description}</h3>
                    <p class="text-gray-700 whitespace-pre-wrap">${sketch}</p>
                `;
                buzhouSketchResults.prepend(sketchElement);
                buzhouSketchInput.value = '';
                showCustomMessage(currentLanguage === 'en' ? "New legend recorded!" : "新传奇已录入！");
            } else {
                showCustomMessage(currentLanguage === 'en' ? "Failed to create sketch." : "创作速写失败。");
            }

            buzhouSketchBtn.disabled = false;
            buzhouSketchBtn.textContent = originalText;
        });
        
        // --- Main App Logic and Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const lang = await setInitialQuote(); 
            updateUIForLanguage(lang);
            initFirebase();
            
            // Initial AI greeting is handled inside initFirebase after session number is set
        });
    </script>
    
    <!-- 用户ID显示区域 -->
    <div class="fixed top-2 right-4 text-xs text-gray-400 z-50">
        <span id="user-id-label">本期编号</span>: <span id="user-id-display">Loading...</span>
    </div>

    <!-- 主画布区域 (Main Canvas) -->
    <div id="main-canvas" class="min-h-screen flex flex-col justify-center items-center p-8 transition-all duration-700">
        
        <!-- 顶部引导语和分享按钮 -->
        <div class="text-center mb-16 max-w-4xl w-full">
            <div id="initial-quote" class="text-center mb-8">
                <!-- Quote will be injected here by JS -->
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="copyQuote()" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:bg-zen-gold/90 transition-all duration-300 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.977l-1.571 1.571A5 5 0 0118 10a5 5 0 01-4.757 4.908l1.571-1.571A3 3 0 1015 8zM5.5 10a.5.5 0 000 1h2.5a.5.5 0 000-1H5.5z" /><path fill-rule="evenodd" d="M3 10a7 7 0 1114 0 7 7 0 01-14 0zm8-4a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" /></svg>
                    <span id="share-button-text">将此智慧送给朋友</span>
                </button>
            </div>
        </div>

        <!-- 四个岛屿区域 (Islands) -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl w-full mt-12">
            
            <!-- 岛屿 1: AI 管家 -->
            <div id="island-ai" onclick="showOverlay('ai')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">🧘</span>
                <h3 id="island-ai-title" class="text-xl font-semibold">AI 管家</h3>
                <p id="island-ai-subtitle" class="text-sm text-gray-600">— 智慧问询 —</p>
            </div>

            <!-- 岛屿 2: 许愿山 -->
            <div id="island-wish" onclick="showOverlay('wish')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">⛰️</span>
                <h3 id="island-wish-title" class="text-xl font-semibold">许愿山</h3>
                <p id="island-wish-subtitle" class="text-sm text-gray-600">— 倾听众生 —</p>
            </div>

            <!-- 岛屿 3: 商店 (黄纸购买) -->
            <div id="island-store" onclick="showOverlay('store')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">🛍️</span>
                <h3 id="island-store-title" class="text-xl font-semibold">法物流通</h3>
                <p id="island-store-subtitle" class="text-sm text-gray-600">— 黄纸供养 —</p>
            </div>

            <!-- 岛屿 4: 不周山 -->
            <div id="island-buzhou" onclick="showOverlay('buzhou')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">✨</span>
                <h3 id="island-buzhou-title" class="text-xl font-semibold">不周山</h3>
                <p id="island-buzhou-subtitle" class="text-sm text-gray-600">— 奇人异志 —</p>
            </div>
        </div>
    </div>

    <!-- 放大区域/浮窗 (Overlays) -->

    <!-- Overlay 1: AI 管家 (AI Butler) -->
    <div id="overlay-ai" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl h-full max-h-[80vh] flex flex-col">
            <h2 id="ai-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                AI 管家: 禅定问答
                <button onclick="hideOverlay('ai')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div id="ai-chat-box" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col bg-zen-sand/30 rounded-xl mb-4">
                <!-- Chat messages here -->
            </div>
            
            <p id="ai-status" class="hidden text-sm text-center text-zen-gold mb-2">AI大师思考中...</p>
            
            <form id="ai-form" class="flex">
                <input type="text" id="ai-input" placeholder="输入您心中的困惑..." class="flex-grow p-3 border border-gray-300 rounded-l-full focus:outline-none focus:ring-2 focus:ring-zen-gold" required>
                <button type="submit" id="ai-submit-btn" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-r-full hover:bg-zen-gold/90 transition-colors">
                    提问
                </button>
            </form>
        </div>
    </div>

    <!-- Overlay 2: 许愿山 (Wish Mountain) - Added Refinement Feature -->
    <div id="overlay-wish" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-3xl h-full max-h-[80vh] flex flex-col">
            <h2 id="wish-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                许愿山: 众生心愿
                <button onclick="hideOverlay('wish')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            
            <!-- 许愿列表 (Waterfall effect) -->
            <div id="wish-list" class="flex-grow overflow-y-auto p-4 space-y-3 bg-zen-sand/30 rounded-xl mb-4">
                <div id="wish-list-loading" class="text-center text-gray-500">加载中... 请稍候片刻，或许下您的心愿。</div>
            </div>
            
            <!-- 许愿表单 -->
            <form id="wish-form" class="flex flex-col">
                <textarea id="wish-input" placeholder="留下您的心愿、困惑或祝福 (不超过100字)..." rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zen-gold mb-3 resize-none" required maxlength="100"></textarea>
                <button type="submit" id="wish-submit-btn" class="w-full py-3 bg-zen-ink text-white font-semibold rounded-xl shadow-md hover:bg-zen-ink/90 transition-colors">
                    发送你的愿望
                </button>
            </form>
        </div>
    </div>

    <!-- Overlay 3: 法物流通 (Store - Yellow Paper) -->
    <div id="overlay-store" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-xl h-auto flex flex-col">
            <h2 id="store-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                法物流通: 许愿材料
                <button onclick="hideOverlay('store')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div class="space-y-6">
                <div class="flex items-center space-x-4">
                    <img onerror="this.onerror=null; this.src='https://placehold.co/100x100/DAA520/FFFFFF?text=纸'" src="https://placehold.co/100x100/DAA520/FFFFFF?text=黄纸" alt="黄纸" class="rounded-lg shadow-md">
                    <div>
                        <h3 id="store-item-title" class="text-2xl font-semibold">高品质许愿黄纸</h3>
                        <p id="store-item-desc" class="text-gray-600">精选上等黄纸，用于书写心愿，心诚则灵。</p>
                        <p id="store-item-price" class="text-xl font-bold text-zen-gold mt-2">￥9.99 / 10张</p>
                    </div>
                </div>
                <div class="p-4 bg-zen-sand/50 rounded-xl text-center">
                    <p id="store-mock-desc" class="font-medium mb-3">此为模拟交易界面，旨在表达心意。</p>
                    <button id="store-mock-btn" class="w-full py-3 bg-zen-ink text-white font-semibold rounded-xl hover:bg-zen-ink/90 transition-colors">
                        立即结缘 (模拟购买)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay 4: 不周山 (Buzhou Mountain - Stories) - Added Sketch Feature -->
    <div id="overlay-buzhou" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-full max-h-[80vh] flex flex-col">
            <h2 id="buzhou-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                不周山: 奇人异士录
                <button onclick="hideOverlay('buzhou')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div class="flex-grow overflow-y-auto p-4 space-y-8">

                <!-- AI Sketch Creation Form -->
                <div class="p-6 bg-zen-sand rounded-2xl shadow-lg border border-zen-gold/30">
                    <h3 id="buzhou-sketch-title" class="text-2xl font-bold mb-4 flex items-center">✨ 奇人速写创作</h3>
                    <form id="buzhou-sketch-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <input type="text" id="buzhou-sketch-input" placeholder="描述一位奇人异士 (例如: 一个会飞的卖豆腐的道士)..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zen-gold" required maxlength="50">
                        <button type="submit" id="buzhou-sketch-btn" class="px-6 py-3 bg-zen-ink text-white font-semibold rounded-xl shadow-md hover:bg-zen-ink/90 transition-colors shrink-0">
                            创作奇人录
                        </button>
                    </form>
                </div>
                
                <!-- AI Generated Sketches will appear here dynamically -->
                <div id="buzhou-sketch-results" class="space-y-6">
                    <!-- Existing Mock Stories -->
                    <div class="p-4 bg-zen-sand/30 rounded-xl shadow-md">
                        <h3 id="buzhou-story-1-title" class="text-2xl font-semibold mb-2">【首位记录者】山中老僧：无名之境</h3>
                        <img onerror="this.onerror=null; this.src='https://placehold.co/800x200/5A6D5A/FFFFFF?text=未来放置图片或视频'" src="https://placehold.co/800x200/5A6D5A/FFFFFF?text=未来放置图片或视频" alt="占位图" class="w-full h-48 object-cover rounded-lg my-3">
                        <p id="buzhou-story-1-content" class="text-gray-700">老僧在不周山闭关三十载，未曾开口言语。他只留下一幅字：“放下”——两个字，道尽世间万般法。他的故事不是关于修行，而是关于存在本身。留待您日后发现更多影像与文字。</p>
                    </div>

                    <div class="p-4 bg-zen-sand/30 rounded-xl shadow-md">
                        <h3 id="buzhou-story-2-title" class="text-2xl font-semibold mb-2">【待续】云游道人：以梦入道</h3>
                        <p id="buzhou-story-2-content" class="text-gray-700">此处将记录一位能够进入他人梦境，以佛法点化迷津的云游道人的故事。他居无定所，行踪不定，唯有心诚者，方能在梦中相遇。敬请期待您未来亲自上传的奇人异士事迹。</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- General UI/Interaction Functions ---
        const overlays = {
            'ai': document.getElementById('overlay-ai'),
            'wish': document.getElementById('overlay-wish'),
            'store': document.getElementById('overlay-store'),
            'buzhou': document.getElementById('overlay-buzhou'),
        };

        function showOverlay(islandName) {
            document.body.style.overflow = 'hidden'; // Lock background scroll
            const overlay = overlays[islandName];
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        function hideOverlay(islandName) {
            const overlay = overlays[islandName];
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            // 检查是否还有其他浮层是活动的，如果没有，则重新启用背景滚动
            const anyActive = Object.values(overlays).some(o => o.classList.contains('active'));
            if (!anyActive) {
                document.body.style.overflow = 'auto'; 
            }
        }
        
        // 【已修复】点击浮层背景关闭浮层
        document.addEventListener('click', (e) => {
            Object.keys(overlays).forEach(key => {
                const overlay = overlays[key];
                
                // 1. 检查浮层是否是活动的
                if (overlay.classList.contains('active')) {
                    
                    // 2. 检查点击目标是否是浮层容器本身 (而不是内部的白色对话框)
                    if (e.target === overlay) {
                        // 点击发生在浮层背景上，隐藏浮层
                        hideOverlay(key);
                    }
                }
            });
        });

        function copyQuote() {
            const quoteText = document.getElementById('initial-quote').textContent.trim();
            
            // Fallback for secure copy in iframe environments
            const tempInput = document.createElement('textarea');
            tempInput.value = `[Zen Canvas] Wisdom for you: ${quoteText}`;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? (currentLanguage === 'en' ? 'Copied to clipboard! Go share the wisdom!' : '已复制到剪贴板，快分享给朋友吧！') : (currentLanguage === 'en' ? 'Copy failed, please copy manually.' : '复制失败，请手动复制。');
                
                showCustomMessage(msg);
                
            } catch (err) {
                console.error('Copy failed:', err);
                showCustomMessage(currentLanguage === 'en' ? 'Copy failed, please copy manually.' : '复制失败，请手动复制。');
            }
            
            document.body.removeChild(tempInput);
        }

        // Custom Message Box (replacing alert())
        function showCustomMessage(message) {
            let msgBox = document.getElementById('custom-message-box');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                msgBox.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-zen-ink text-white p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0 z-[100] text-center max-w-xs';
                document.body.appendChild(msgBox);
            }
            
            msgBox.textContent = message;
            // Force reflow to restart transition
            msgBox.classList.remove('opacity-0');
            void msgBox.offsetWidth; 
            msgBox.classList.add('opacity-100');
            
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, 3000); // Hide after 3 seconds
        }

        // Add event listeners for key press to close overlays 
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                Object.values(overlays).forEach(overlay => {
                    if (overlay.classList.contains('active')) {
                        hideOverlay(overlay.id.replace('overlay-', ''));
                    }
                });
            }
        });
    </script>
</body>
</html>
