<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wxCheese – Where your smile grows and travels far</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 设置 Firebase 日志级别，便于调试
        setLogLevel('debug'); 

        // 全局 Firebase 变量
        let db;
        let auth;
        let userId = 'loading'; // 用户的唯一 ID

        // 检查全局变量是否存在并初始化 Firebase
        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or invalid.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 登录认证
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...'; // 简短显示
                        console.log("Firebase Auth successful. User ID:", userId);
                        // 初始化完成后，确保数据集合存在（仅在首次运行时创建默认数据）
                        initializeCollections(appId);
                    } else {
                        userId = 'anonymous';
                        document.getElementById('user-id-display').textContent = 'ANONYMOUS';
                        console.log("Firebase Auth: Anonymous sign-in.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // 确保必要的集合和初始数据存在
        const initializeCollections = async (appId) => {
            const storeRef = collection(db, `artifacts/${appId}/public/data/store_items`);
            const buzhouRef = collection(db, `artifacts/${appId}/public/data/buzhou_content`);

            // 检查 Store 集合是否为空，如果为空，添加默认商品
            const storeSnapshot = await getDoc(doc(storeRef, 'mock_item_check'));
            if (!storeSnapshot.exists()) {
                console.log("Setting up initial Store and Buzhou data...");
                await setDoc(doc(storeRef, 'mock_item_check'), { name: 'Initial Check', price: 0, description: 'Do not delete.', createdAt: serverTimestamp() });
                await addDoc(storeRef, {
                    name: currentLanguage === 'zh' ? '禅定黄纸 (小份)' : 'Zen Offering Paper (Small)',
                    price: 5.00,
                    description: currentLanguage === 'zh' ? '用于许愿山的标准供养材料。' : 'Standard offering material for Wish Mountain.',
                    image_url: 'https://placehold.co/100x100/DAA520/FFFFFF?text=Paper',
                    available: true,
                    createdAt: serverTimestamp()
                });
                await addDoc(storeRef, {
                    name: currentLanguage === 'zh' ? '冥想香炉 (限量)' : 'Meditation Incense Burner (L.E.)',
                    price: 99.99,
                    description: currentLanguage === 'zh' ? '增强专注力的限量版香炉。' : 'Limited edition burner to enhance focus.',
                    image_url: 'https://placehold.co/100x100/333333/FFFFFF?text=Burner',
                    available: true,
                    createdAt: serverTimestamp()
                });

                // 检查 Buzhou 集合是否为空，如果为空，添加默认内容
                await setDoc(doc(buzhouRef, 'mock_content_check'), { title: 'Initial Check', content: 'Do not delete.', createdAt: serverTimestamp() });
                await addDoc(buzhouRef, {
                    title: currentLanguage === 'zh' ? '六祖慧能传' : 'The Story of Huineng',
                    content: currentLanguage === 'zh' ? '菩提本无树，明镜亦非台，本来无一物，何处惹尘埃。' : 'Bodhi is fundamentally no tree, Nor is the clear mirror a stand. Fundamentally there is not a single thing, Where can dust alight?',
                    author: '佚名',
                    createdAt: serverTimestamp()
                });
            }
        };

        // 绑定到全局 scope
        window.db = db;
        window.auth = auth;
        window.getFirestore = getFirestore;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.orderBy = orderBy;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>

    <script>
        let currentLanguage = 'zh'; 
        let chatHistory = []; // 存储 AI 聊天历史 for context

        // --- 多语言翻译映射 ---
        const translations = {
            'zh': {
                'island-ai-title': 'AI 管家', 'island-ai-subtitle': '— 智慧问询 —',
                'island-wish-title': '许愿山', 'island-wish-subtitle': '— 倾听众生 —',
                'island-store-title': '法物流通', 'island-store-subtitle': '— 黄纸供养 —',
                'island-buzhou-title': '不周山', 'island-buzhou-subtitle': '— 奇人异志 —',
                'share-button': '将此智慧送给朋友', 'user-id-label': '会话编号', 
                
                'ai-overlay-title': 'AI 管家: 禅定问答',
                'wish-overlay-title': '许愿山: 众生心愿',
                'store-overlay-title': '法物流通: 黄纸供养',
                'buzhou-overlay-title': '不周山: 奇人异士录',

                'close-button': '返回主页',
                
                // AI Chat Specific
                'ai-input-placeholder': '向 AI 管家提问...', 'ai-send-button': '发送',
                'ai-loading-message': 'AI 管家正在禅定思考...', 'ai-error-message': '禅定失败。请稍后重试。',
                'ai-system-prompt': '你是一位富有智慧、平静和耐心的禅宗管家。你的回答应该简洁、富有哲理和启发性，专注于正念和内心平静。',
                'ai-reset-button': '清空对话',

                // Wish Mountain Specific
                'wish-input-placeholder': '写下您的心愿...',
                'wish-submit-button': '提交心愿',
                'wish-count-label': '当前心愿总数',
                'wish-success': '心愿已提交，愿力随风而逝。',
                'wish-error': '提交心愿失败。',
                'wish-empty': '还没有人许愿，您是第一个吗？',

                // Store Specific
                'store-no-items': '法物流通中暂时没有可供养的物品。',
                'store-buy-button': '供养',
                'store-purchase-success': '供养请求已发送！感谢您的善意。实际支付集成需要后台支持。',

                // Buzhou Specific
                'buzhou-no-content': '不周山暂时处于云雾缭绕中，等待新的奇人异志出现。',

                // Local Quotes
                'quotes': [
                    "心生种种法生，心灭种种法灭。——《华严经》",
                    "一切有为法，如梦幻泡影，如露亦如电，应作如是观。——《金刚经》",
                    "菩提本无树，明镜亦非台，本来无一物，何处惹尘埃。——六祖慧能",
                ]
            },
            'en': {
                // ... (English translations structure remains the same for brevity)
                'island-ai-title': 'AI Butler', 'island-ai-subtitle': '— Ask Me —',
                'island-wish-title': 'Wish Mountain', 'island-wish-subtitle': '— Make a Wish —',
                'island-store-title': 'Store', 'island-store-subtitle': '— Offerings —',
                'island-buzhou-title': 'Buzhou Mountain', 'island-buzhou-subtitle': '— Tales of the Wise —',
                'share-button': 'Share This Wisdom', 'user-id-label': 'Session No.', 
                
                'ai-overlay-title': 'AI Butler: Zen Dialogue',
                'wish-overlay-title': 'Wish Mountain: Wishes of Beings',
                'store-overlay-title': 'Store: Offering Materials',
                'buzhou-overlay-title': 'Buzhou Mountain: Chronicle of the Extraordinary',

                'close-button': 'Return to Canvas',
                
                'ai-input-placeholder': 'Ask the AI Butler...', 'ai-send-button': 'Send',
                'ai-loading-message': 'AI Butler is in deep meditation...', 'ai-error-message': 'Meditation failed. Please try again later.',
                'ai-system-prompt': 'You are a wise, calm, and patient Zen butler. Your answers should be concise, philosophical, and inspiring, focused on mindfulness and inner peace.',
                'ai-reset-button': 'Clear Chat',

                'wish-input-placeholder': 'Write down your wish...',
                'wish-submit-button': 'Submit Wish',
                'wish-count-label': 'Total Wishes',
                'wish-success': 'Wish submitted. May your intention travel far.',
                'wish-error': 'Failed to submit wish.',
                'wish-empty': 'No wishes yet. Will you be the first?',

                'store-no-items': 'No items currently available for offering.',
                'store-buy-button': 'Offer',
                'store-purchase-success': 'Offering request sent! Thank you for your kindness. Actual payment integration requires backend support.',

                'buzhou-no-content': 'Buzhou Mountain is currently shrouded in mist, awaiting new tales of the extraordinary.',

                'quotes': [
                    "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.——Buddha",
                    "The mind is everything. What you think you become.——Buddha",
                    "The greatest prayer is patience.——Buddha",
                ]
            }
        };
        
        // --- UI & Language Helpers ---
        const updateUIForLanguage = (lang) => {
            const t = translations[lang] || translations['en']; 
            document.documentElement.lang = lang;
            document.getElementById('island-ai-title').textContent = t['island-ai-title'];
            document.getElementById('island-ai-subtitle').textContent = t['island-ai-subtitle'];
            document.getElementById('island-wish-title').textContent = t['island-wish-title'];
            document.getElementById('island-wish-subtitle').textContent = t['island-wish-subtitle'];
            document.getElementById('island-store-title').textContent = t['island-store-title'];
            document.getElementById('island-store-subtitle').textContent = t['island-store-subtitle'];
            document.getElementById('island-buzhou-title').textContent = t['island-buzhou-title'];
            document.getElementById('island-buzhou-subtitle').textContent = t['island-buzhou-subtitle'];
            document.getElementById('share-button-text').innerHTML = t['share-button'];
            document.getElementById('user-id-label').textContent = t['user-id-label'];
            document.title = 'wxCheese – Where your smile grows and travels far';
        };

        const setInitialQuote = async () => {
            const detectedLangFull = navigator.language || navigator.userLanguage || 'en-US'; 
            const langCode = detectedLangFull.split('-')[0]; 
            const targetLang = (langCode === 'zh' || langCode === 'en') ? langCode : 'en';
            currentLanguage = targetLang;
            const t = translations[targetLang];
            const quoteArray = t['quotes'];
            const randomIndex = Math.floor(Math.random() * quoteArray.length);
            const quoteText = quoteArray[randomIndex];
            const parts = quoteText.split('——');
            const quote = parts[0] || t['quotes'][0].split('——')[0];
            const source = parts[1] || '【Buddhist Wisdom】';
            
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8">
                    ${quote}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    ${source}
                </div>
            `;
            return targetLang;
        };

        window.copyQuote = function() {
            // ... (copyQuote implementation remains the same)
            const quoteText = document.getElementById('initial-quote').textContent.trim();
            const rawQuote = quoteText.split('——')[0].trim(); 
            const tempInput = document.createElement('textarea');
            tempInput.value = rawQuote;
            document.body.appendChild(tempInput);
            tempInput.select();
            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(tempInput);
            if (successful) {
                const msg = currentLanguage === 'en' ? 'Copied!' : '已复制！'; 
                showCustomMessage(msg, 'success');
            } else {
                const errorMsg = currentLanguage === 'en' ? 'Copy failed, please copy manually.' : '复制失败，请手动复制。';
                showCustomMessage(errorMsg, 'error');
            }
        }
        
        function showCustomMessage(message, type) {
            // ... (showCustomMessage implementation remains the same)
            let msgBox = document.getElementById('custom-message-box');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                document.body.appendChild(msgBox);
            }
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            msgBox.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ${bgColor} text-white p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0 z-[100] text-center max-w-xs`;
            msgBox.textContent = message;
            msgBox.classList.remove('opacity-0');
            void msgBox.offsetWidth; 
            msgBox.classList.add('opacity-100');
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, 3000); 
        }

        function showOverlay() {
            document.body.style.overflow = 'hidden'; 
            document.getElementById('overlay-container').classList.add('active');
        }

        window.hideOverlay = function() {
            document.getElementById('overlay-container').classList.remove('active');
            document.body.style.overflow = 'auto'; 
        }

        // --- Core Feature Dispatcher ---
        window.showIslandOverlay = function(islandId, titleKey) {
            if (!window.db) {
                showCustomMessage('正在连接禅境 (数据库初始化中)...', 'error');
                return;
            }

            switch (islandId) {
                case 'ai':
                    showAIChat(titleKey);
                    break;
                case 'wish':
                    showWishMountain(titleKey);
                    break;
                case 'store':
                    showStore(titleKey);
                    break;
                case 'buzhou':
                    showBuzhou(titleKey);
                    break;
            }
        }
        
        // --- AI Chat Implementation (Same as previous, using global chatHistory) ---
        function showAIChat(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            // HTML for AI Chat interface
            const contentHtml = `
                <div id="ai-chat-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="resetChat()" class="text-sm text-gray-500 hover:text-red-500 transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.836 0H20v-5m-7 0v10m0 0v10" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M16 6l-4 4-4-4" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14V4M7 14V4" /></svg>
                            ${t['ai-reset-button']}
                        </button>
                    </div>
                    
                    <div id="chat-messages" class="flex-grow space-y-4 p-2 mb-4"></div>
                    
                    <div class="flex space-x-3">
                        <input id="chat-input" type="text" placeholder="${t['ai-input-placeholder']}" 
                               class="flex-grow border-2 border-zen-sand p-3 rounded-xl focus:outline-none focus:border-zen-gold transition-colors"
                               onkeydown="if(event.key === 'Enter') handleSend()">
                        <button id="send-button" onclick="handleSend()" 
                                class="px-6 py-3 bg-zen-ink text-white font-semibold rounded-xl hover:bg-zen-ink/90 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                            <span class="ml-2 hidden sm:inline">${t['ai-send-button']}</span>
                        </button>
                    </div>
                    <button onclick="hideOverlay()" class="absolute top-4 right-4 text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();
            renderChatHistory();
        }

        // Function definitions for AI chat (renderChatHistory, handleSend, resetChat, generateAIResponse)
        function renderChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                bubble.innerHTML = `
                    <div class="p-3 rounded-2xl shadow-md whitespace-pre-wrap ${msg.role === 'user' ? 'user-bubble rounded-tr-none' : 'ai-bubble rounded-tl-none'}">
                        ${msg.parts[0].text}
                    </div>
                `;
                messagesContainer.appendChild(bubble);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        window.handleSend = function() {
            const input = document.getElementById('chat-input');
            const userText = input.value.trim();
            if (!userText) return;
            const userMessage = { role: "user", parts: [{ text: userText }] };
            chatHistory.push(userMessage);
            renderChatHistory();
            input.value = '';
            const loadingMessage = { role: "model", parts: [{ text: translations[currentLanguage]['ai-loading-message'] }], isTemp: true };
            chatHistory.push(loadingMessage);
            renderChatHistory();
            generateAIResponse(userText);
        }
        
        window.resetChat = function() {
            chatHistory = [];
            renderChatHistory();
            showCustomMessage(translations[currentLanguage]['ai-reset-button'] + '!', 'success');
        }

        async function generateAIResponse(userQuery, maxRetries = 5) {
            const t = translations[currentLanguage];
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            chatHistory = chatHistory.filter(msg => !msg.isTemp);
            const systemPrompt = t['ai-system-prompt'];
            const contents = chatHistory.map(msg => ({ 
                role: msg.role === 'user' ? 'user' : 'model', 
                parts: msg.parts 
            }));
            contents.push({ role: 'user', parts: [{ text: userQuery }] });

            const payload = {
                contents: contents,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (aiText) {
                        const aiMessage = { role: "model", parts: [{ text: aiText }] };
                        chatHistory.push(aiMessage);
                        renderChatHistory();
                        return;
                    } else {
                        throw new Error("Invalid response format from AI.");
                    }

                } catch (error) {
                    console.error("AI Generation Error:", error);
                    if (attempt === maxRetries - 1) {
                        const errorMessage = { role: "model", parts: [{ text: t['ai-error-message'] + ` (${error.message})` }] };
                        chatHistory.push(errorMessage);
                        renderChatHistory();
                    }
                }
            }
        }
        
        // --- Feature 2: Wish Mountain (Firestore Enabled) ---
        function showWishMountain(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const contentHtml = `
                <div id="wish-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${t['wish-count-label']}: <span id="wish-count" class="text-zen-gold">...</span></p>
                    </div>

                    <div id="wishes-list" class="flex-grow space-y-3 p-2 mb-4 overflow-y-auto bg-zen-sand/50 rounded-xl">
                        <!-- Wishes will be loaded here -->
                        <div class="text-center text-gray-400 p-8" id="wish-loading">正在加载心愿...</div>
                    </div>
                    
                    <form onsubmit="submitWish(event)" class="flex flex-col space-y-3 mt-4">
                        <textarea id="wish-input" placeholder="${t['wish-input-placeholder']}" rows="2"
                                  class="border-2 border-zen-sand p-3 rounded-xl focus:outline-none focus:border-zen-gold transition-colors resize-none"></textarea>
                        <button type="submit" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-xl hover:bg-zen-gold/90 transition-colors">
                            ${t['wish-submit-button']}
                        </button>
                    </form>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();
            
            // 启动实时监听
            const wishesRef = collection(window.db, `artifacts/${appId}/public/data/wishes`);
            const q = query(wishesRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                const wishesListEl = document.getElementById('wishes-list');
                const wishCountEl = document.getElementById('wish-count');
                if (!wishesListEl || !wishCountEl) return;
                
                document.getElementById('wish-loading').style.display = 'none';

                let wishCount = 0;
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.text) { // 确保有内容
                        wishCount++;
                        const timestamp = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US') : '刚刚';
                        const displayUserId = data.userId ? data.userId.substring(0, 4) + '...' : '匿名';
                        
                        html += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-zen-sand">
                                <p class="text-gray-700 whitespace-pre-wrap">${data.text}</p>
                                <div class="text-xs text-gray-400 mt-2 flex justify-between">
                                    <span>${timestamp}</span>
                                    <span>ID: ${displayUserId}</span>
                                </div>
                            </div>
                        `;
                    }
                });

                if (wishCount === 0) {
                    html = `<div class="text-center text-gray-400 p-8">${t['wish-empty']}</div>`;
                }

                wishesListEl.innerHTML = html;
                wishCountEl.textContent = wishCount;
            }, (error) => {
                console.error("Error listening to wishes:", error);
                const wishesListEl = document.getElementById('wishes-list');
                if (wishesListEl) wishesListEl.innerHTML = `<div class="text-center text-red-500 p-8">${t['wish-error']}</div>`;
            });
        }

        window.submitWish = async function(event) {
            event.preventDefault();
            const inputEl = document.getElementById('wish-input');
            const wishText = inputEl.value.trim();
            if (!wishText) return;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const wishesRef = collection(window.db, `artifacts/${appId}/public/data/wishes`);
                
                await addDoc(wishesRef, {
                    text: wishText,
                    userId: window.auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                });

                inputEl.value = '';
                showCustomMessage(translations[currentLanguage]['wish-success'], 'success');
            } catch (e) {
                console.error("Error submitting wish:", e);
                showCustomMessage(translations[currentLanguage]['wish-error'], 'error');
            }
        }

        // --- Feature 3: Store (Firestore Enabled) ---
        function showStore(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const contentHtml = `
                <div id="store-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div id="store-items" class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 p-2 mb-4 overflow-y-auto">
                        <div class="text-center text-gray-400 p-8 col-span-full" id="store-loading">正在加载法物流通物品...</div>
                    </div>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();

            const storeRef = collection(window.db, `artifacts/${appId}/public/data/store_items`);
            // 使用 onSnapshot 实时监听商品列表
            onSnapshot(storeRef, (snapshot) => {
                const itemsContainer = document.getElementById('store-items');
                if (!itemsContainer) return;
                
                itemsContainer.innerHTML = '';
                let itemsCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.available && data.price > 0) { // 仅显示上架且有价格的商品
                        itemsCount++;
                        itemsContainer.innerHTML += `
                            <div class="bg-zen-sand p-4 rounded-xl shadow-md flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                                <img src="${data.image_url}" alt="${data.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-300">
                                <div class="flex-grow text-center sm:text-left">
                                    <h3 class="text-xl font-semibold">${data.name}</h3>
                                    <p class="text-sm text-gray-600 mb-1">${data.description}</p>
                                    <p class="text-2xl text-zen-gold font-bold">¥${data.price.toFixed(2)}</p>
                                </div>
                                <button onclick="simulatePurchase('${data.name}', ${data.price})" class="px-4 py-2 bg-zen-ink text-white font-medium rounded-lg hover:bg-zen-ink/90 transition-colors w-full sm:w-auto">
                                    ${t['store-buy-button']}
                                </button>
                            </div>
                        `;
                    }
                });

                if (itemsCount === 0) {
                    itemsContainer.innerHTML = `<div class="text-center text-gray-400 p-8 col-span-full">${t['store-no-items']}</div>`;
                }
            }, (error) => {
                console.error("Error listening to store items:", error);
                const itemsContainer = document.getElementById('store-items');
                if (itemsContainer) itemsContainer.innerHTML = `<div class="text-center text-red-500 p-8 col-span-full">加载商品失败。</div>`;
            });
        }

        window.simulatePurchase = function(itemName, itemPrice) {
            // 这是模拟的购买功能，实际需要集成支付网关
            console.log(`Simulated purchase initiated: ${itemName} for ¥${itemPrice}`);
            showCustomMessage(`${translations[currentLanguage]['store-purchase-success']}`, 'success');
        }

        // --- Feature 4: Buzhou Mountain (Firestore Enabled) ---
        function showBuzhou(titleKey) {
            const t = translations[currentLanguage];
            const overlayContainer = document.getElementById('overlay-container');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const contentHtml = `
                <div id="buzhou-content" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h2 class="text-3xl font-bold text-zen-gold">${t[titleKey]}</h2>
                        <button onclick="hideOverlay()" class="text-gray-500 hover:text-zen-ink transition-colors p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    
                    <div id="buzhou-articles" class="flex-grow space-y-6 p-2 mb-4 overflow-y-auto">
                        <div class="text-center text-gray-400 p-8" id="buzhou-loading">正在加载奇人异志...</div>
                    </div>
                </div>
            `;
            overlayContainer.innerHTML = contentHtml;
            showOverlay();

            const buzhouRef = collection(window.db, `artifacts/${appId}/public/data/buzhou_content`);
            const q = query(buzhouRef, orderBy("createdAt", "desc"));

            // 实时监听 Buzhou 内容
            onSnapshot(q, (snapshot) => {
                const articlesContainer = document.getElementById('buzhou-articles');
                if (!articlesContainer) return;
                
                articlesContainer.innerHTML = '';
                let contentCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.title && data.content) { 
                        contentCount++;
                        const timestamp = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US') : '未知时间';
                        
                        articlesContainer.innerHTML += `
                            <div class="p-6 bg-zen-sand rounded-xl shadow-lg">
                                <h3 class="text-2xl font-bold text-zen-ink mb-2">${data.title}</h3>
                                <p class="text-sm text-zen-gold mb-3">作者: ${data.author || '匿名'} | ${timestamp}</p>
                                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${data.content}</p>
                            </div>
                        `;
                    }
                });

                if (contentCount === 0) {
                    articlesContainer.innerHTML = `<div class="text-center text-gray-400 p-8">${t['buzhou-no-content']}</div>`;
                }
            }, (error) => {
                console.error("Error listening to Buzhou content:", error);
                const articlesContainer = document.getElementById('buzhou-articles');
                if (articlesContainer) articlesContainer.innerHTML = `<div class="text-center text-red-500 p-8">加载内容失败。</div>`;
            });
        }
        
        // --- Event Listeners (Remain the same) ---
        document.addEventListener('click', (e) => {
            const overlay = document.getElementById('overlay-container');
            if (overlay.classList.contains('active') && e.target === overlay) {
                hideOverlay();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('overlay-container').classList.contains('active')) {
                hideOverlay();
            }
        });
        
        // --- Main App Logic and Initialization ---
        const initialQuoteEl = document.getElementById('initial-quote');
        document.addEventListener('DOMContentLoaded', async () => {
            const lang = await setInitialQuote(); 
            updateUIForLanguage(lang);
        });
    </script>
    
    <!-- 用户ID显示区域 (Firebase Auth Status) -->
    <div class="fixed top-2 right-4 text-xs text-gray-400 z-50">
        <span id="user-id-label">会话编号</span>: <span id="user-id-display">Connecting...</span>
    </div>

    <!-- 主画布区域 (Main Canvas) -->
    <div id="main-canvas" class="min-h-screen flex flex-col justify-center items-center p-8 transition-all duration-700">
        
        <!-- 顶部引导语和分享按钮 -->
        <div class="text-center mb-16 max-w-4xl w-full">
            <div id="initial-quote" class="text-center mb-8"></div>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="copyQuote()" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:bg-zen-gold/90 transition-all duration-300 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.977l-1.571 1.571A5 5 0 0118 10a5 5 0 01-4.757 4.908l1.571-1.571A3 3 0 1015 8zM5.5 10a.5.5 0 000 1h2.5a.5.5 0 000-1H5.5z" /><path fill-rule="evenodd" d="M3 10a7 7 0 1114 0 7 7 0 01-14 0zm8-4a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" /></svg>
                    <span id="share-button-text">将此智慧送给朋友</span>
                </button>
            </div>
        </div>

        <!-- 四个岛屿区域 (Islands) -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl w-full mt-12">
            
            <!-- 岛屿 1: AI 管家 -->
            <div id="island-ai" onclick="showIslandOverlay('ai', 'ai-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">🧘</span>
                <h3 id="island-ai-title" class="text-xl font-semibold">AI 管家</h3>
                <p id="island-ai-subtitle" class="text-sm text-gray-600">— 智慧问询 —</p>
            </div>

            <!-- 岛屿 2: 许愿山 -->
            <div id="island-wish" onclick="showIslandOverlay('wish', 'wish-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">⛰️</span>
                <h3 id="island-wish-title" class="text-xl font-semibold">许愿山</h3>
                <p id="island-wish-subtitle" class="text-sm text-gray-600">— 倾听众生 —</p>
            </div>

            <!-- 岛屿 3: 商店 -->
            <div id="island-store" onclick="showIslandOverlay('store', 'store-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">🛍️</span>
                <h3 id="island-store-title" class="text-xl font-semibold">法物流通</h3>
                <p id="island-store-subtitle" class="text-sm text-gray-600">— 黄纸供养 —</p>
            </div>

            <!-- 岛屿 4: 不周山 -->
            <div id="island-buzhou" onclick="showIslandOverlay('buzhou', 'buzhou-overlay-title')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">✨</span>
                <h3 id="island-buzhou-title" class="text-xl font-semibold">不周山</h3>
                <p id="island-buzhou-subtitle" class="text-sm text-gray-600">— 奇人异志 —</p>
            </div>
        </div>
    </div>

    <!-- 统一的放大区域/浮窗容器 (Overlays Container) -->
    <div id="overlay-container" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <!-- Overlay Content will be dynamically injected here -->
    </div>

</body>
</html>
