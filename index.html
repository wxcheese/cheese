<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- UPDATED: New Website Title -->
    <title>wxCheese â€“ Where your smile grows and travels far</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    },
                    colors: {
                        'zen-white': '#FDFDFD',
                        'zen-sand': '#EFEBE9',
                        'zen-gold': '#DAA520',
                        'zen-ink': '#333333',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            overflow: hidden; /* é˜²æ­¢ä¸»é¡µé¢æ»šåŠ¨ */
            background-color: #FDFDFD;
            min-height: 100vh;
        }

        /* æ¨¡æ‹Ÿç”»å¸ƒå’Œå²›å±¿çš„è¿‡æ¸¡æ•ˆæœ */
        .island-card {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .island-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* æ”¾å¤§è¿›å…¥ï¼ˆModal/Overlayï¼‰æ•ˆæœ */
        .zoom-overlay {
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
            visibility: hidden;
            opacity: 0;
            z-index: 50;
        }
        .zoom-overlay.active {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans text-zen-ink">

    <!-- Firebase and Google API Dependencies -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, orderBy, addDoc, serverTimestamp, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug'); // Enable Firestore logging

        // --- Global Firebase and API Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'zen-canvas-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const AI_MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent`;
        const API_KEY = ""; // Canvas provides this dynamically

        let db = null;
        let auth = null;
        let userId = null;
        let currentLanguage = 'zh'; // Default language

        // --- Core Firebase Initialization and Authentication ---
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("Auth State Changed. User ID:", userId);
                        // Once authenticated, start the Wish Mountain listener
                        setupWishMountainListener(db);
                    } else {
                        // Use a fallback UUID if auth fails (shouldn't happen in canvas)
                        userId = crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = 'Guest-' + userId.substring(0, 8);
                        console.log("User signed out or authentication failed. Using fallback ID.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
            }
        };

        // --- Multi-Language Translation Map ---
        const translations = {
            'zh': {
                // Main Islands
                'island-ai-title': 'AI ç®¡å®¶',
                'island-ai-subtitle': 'â€” æ™ºæ…§é—®è¯¢ â€”',
                'island-wish-title': 'è®¸æ„¿å±±',
                'island-wish-subtitle': 'â€” å€¾å¬ä¼—ç”Ÿ â€”',
                'island-store-title': 'æ³•ç‰©æµé€š',
                'island-store-subtitle': 'â€” é»„çº¸ä¾›å…» â€”',
                'island-buzhou-title': 'ä¸å‘¨å±±',
                'island-buzhou-subtitle': 'â€” å¥‡äººå¼‚å¿— â€”',
                'share-button': 'å°†æ­¤æ™ºæ…§é€ç»™æœ‹å‹',
                
                // Overlays
                'ai-overlay-title': 'AI ç®¡å®¶: ç¦…å®šé—®ç­”',
                'ai-input-placeholder': 'è¾“å…¥æ‚¨å¿ƒä¸­çš„å›°æƒ‘...',
                'ai-submit-btn': 'æé—®',
                'ai-status': 'AIå¤§å¸ˆæ€è€ƒä¸­...',
                'ai-initial-greeting': "æ¬¢è¿æ¥åˆ°ç¦…æ„ç”»å¸ƒã€‚å¾ä¹ƒæ­¤åœ°AIç®¡å®¶ï¼Œå¯ä¸ºæ‚¨ç­”ç–‘è§£æƒ‘ã€‚è¯·é—®æ‚¨å¿ƒä¸­æœ‰ä½•å›°æƒ‘æˆ–å‘å¾€ï¼Ÿ",
                
                'wish-overlay-title': 'è®¸æ„¿å±±: ä¼—ç”Ÿå¿ƒæ„¿',
                'wish-list-loading': 'åŠ è½½ä¸­... è¯·ç¨å€™ç‰‡åˆ»ï¼Œæˆ–è®¸ä¸‹æ‚¨çš„å¿ƒæ„¿ã€‚',
                'wish-input-placeholder': 'ç•™ä¸‹æ‚¨çš„å¿ƒæ„¿ã€å›°æƒ‘æˆ–ç¥ç¦ (ä¸è¶…è¿‡100å­—)...',
                'wish-submit-btn': 'å‘é€ä½ çš„æ„¿æœ›',
                'wish-loading-status': 'è®¸æ„¿ä¸­...',
                
                // Store
                'store-overlay-title': 'æ³•ç‰©æµé€š: è®¸æ„¿ææ–™',
                'store-item-title': 'é«˜å“è´¨è®¸æ„¿é»„çº¸',
                'store-item-desc': 'ç²¾é€‰ä¸Šç­‰é»„çº¸ï¼Œç”¨äºä¹¦å†™å¿ƒæ„¿ï¼Œå¿ƒè¯šåˆ™çµã€‚',
                'store-item-price': 'ï¿¥9.99 / 10å¼ ',
                'store-mock-desc': 'æ­¤ä¸ºæ¨¡æ‹Ÿäº¤æ˜“ç•Œé¢ï¼Œæ—¨åœ¨è¡¨è¾¾å¿ƒæ„ã€‚',
                'store-mock-btn': 'ç«‹å³ç»“ç¼˜ (æ¨¡æ‹Ÿè´­ä¹°)',

                // Buzhou
                'buzhou-overlay-title': 'ä¸å‘¨å±±: å¥‡äººå¼‚å£«å½•',
                'buzhou-story-1-title': 'ã€é¦–ä½è®°å½•è€…ã€‘å±±ä¸­è€åƒ§ï¼šæ— åä¹‹å¢ƒ',
                'buzhou-story-1-content': 'è€åƒ§åœ¨ä¸å‘¨å±±é—­å…³ä¸‰åè½½ï¼Œæœªæ›¾å¼€å£è¨€è¯­ã€‚ä»–åªç•™ä¸‹ä¸€å¹…å­—ï¼šâ€œæ”¾ä¸‹â€â€”â€”ä¸¤ä¸ªå­—ï¼Œé“å°½ä¸–é—´ä¸‡èˆ¬æ³•ã€‚ä»–çš„æ•…äº‹ä¸æ˜¯å…³äºä¿®è¡Œï¼Œè€Œæ˜¯å…³äºå­˜åœ¨æœ¬èº«ã€‚ç•™å¾…æ‚¨æ—¥åå‘ç°æ›´å¤šå½±åƒä¸æ–‡å­—ã€‚',
                'buzhou-story-2-title': 'ã€å¾…ç»­ã€‘äº‘æ¸¸é“äººï¼šä»¥æ¢¦å…¥é“',
                'buzhou-story-2-content': 'æ­¤å¤„å°†è®°å½•ä¸€ä½èƒ½å¤Ÿè¿›å…¥ä»–äººæ¢¦å¢ƒï¼Œä»¥ä½›æ³•ç‚¹åŒ–è¿·æ´¥çš„äº‘æ¸¸é“äººçš„æ•…äº‹ã€‚ä»–å±…æ— å®šæ‰€ï¼Œè¡Œè¸ªä¸å®šï¼Œå”¯æœ‰å¿ƒè¯šè€…ï¼Œæ–¹èƒ½åœ¨æ¢¦ä¸­ç›¸é‡ã€‚æ•¬è¯·æœŸå¾…æ‚¨æœªæ¥äº²è‡ªä¸Šä¼ çš„å¥‡äººå¼‚å£«äº‹è¿¹ã€‚',
            },
            'en': {
                // Main Islands
                'island-ai-title': 'AI Butler',
                'island-ai-subtitle': 'â€” Ask Me â€”',
                'island-wish-title': 'Wish Mountain',
                'island-wish-subtitle': 'â€” Make a Wish â€”',
                'island-store-title': 'Store',
                'island-store-subtitle': 'â€” Offerings â€”',
                'island-buzhou-title': 'Hogwarts',
                'island-buzhou-subtitle': 'â€” Tales of the Wise â€”',
                'share-button': 'Share This Wisdom',
                
                // Overlays
                'ai-overlay-title': 'AI Butler: Zen Dialogue',
                'ai-input-placeholder': 'Type your question or concern...',
                'ai-submit-btn': 'Ask',
                'ai-status': 'AI Master is meditating...',
                'ai-initial-greeting': "Welcome to the Zen Canvas. I am the AI Butler, here to answer your questions. What burdens your heart or what do you aspire to?",
                
                'wish-overlay-title': 'Wish Mountain: Wishes of Beings',
                'wish-list-loading': 'Loading wishes... Please wait or make your own wish.',
                'wish-input-placeholder': 'Leave your wish, concern, or blessing (max 100 characters)...',
                'wish-submit-btn': 'Send Your Wish',
                'wish-loading-status': 'Wishing in progress...',

                // Store
                'store-overlay-title': 'Store: Offering Materials',
                'store-item-title': 'High-Quality Yellow Paper',
                'store-item-desc': 'Finely selected paper for writing wishes. Sincerity brings forth results.',
                'store-item-price': '$9.99 / 10 Sheets',
                'store-mock-desc': 'This is a simulated transaction interface, intended to express intent.',
                'store-mock-btn': 'Acquire Immediately (Simulated)',

                // Buzhou
                'buzhou-overlay-title': 'Hogwarts: Chronicle of the Extraordinary',
                'buzhou-story-1-title': 'ã€First Recordedã€‘The Old Monk: State of No-Name',
                'buzhou-story-1-content': 'The old monk meditated in Buzhou Mountain for thirty years without uttering a word. He only left one calligraphy scroll: "Let Go"â€”two words that express the entirety of worldly Dharma. His story is not about practice, but about existence itself. More images and texts await your future discovery.',
                'buzhou-story-2-title': 'ã€To be Continuedã€‘Wandering Taoist: Entering the Path through Dreams',
                'buzhou-story-2-content': 'This records the story of a wandering Taoist who can enter others\' dreams and enlighten the lost with Dharma. He has no fixed dwelling, and his whereabouts are unknown. Only the truly sincere may encounter him in their dreams. Look forward to future tales of extraordinary individuals uploaded by you.',
            }
        };

        /**
         * Updates all static UI elements based on the detected language.
         * @param {string} lang 'zh' or 'en'.
         */
        const updateUIForLanguage = (lang) => {
            const t = translations[lang] || translations['en']; 

            // Update HTML lang attribute
            document.documentElement.lang = lang;

            // 1. Main Islands
            document.getElementById('island-ai-title').textContent = t['island-ai-title'];
            document.getElementById('island-ai-subtitle').textContent = t['island-ai-subtitle'];
            document.getElementById('island-wish-title').textContent = t['island-wish-title'];
            document.getElementById('island-wish-subtitle').textContent = t['island-wish-subtitle'];
            document.getElementById('island-store-title').textContent = t['island-store-title'];
            document.getElementById('island-store-subtitle').textContent = t['island-store-subtitle'];
            document.getElementById('island-buzhou-title').textContent = t['island-buzhou-title'];
            document.getElementById('island-buzhou-subtitle').textContent = t['island-buzhou-subtitle'];
            
            // 2. Share Button
            document.getElementById('share-button-text').innerHTML = t['share-button'];

            // 3. AI Overlay
            document.getElementById('ai-overlay-title').textContent = t['ai-overlay-title'];
            document.getElementById('ai-input').placeholder = t['ai-input-placeholder'];
            document.getElementById('ai-submit-btn').textContent = t['ai-submit-btn'];
            document.getElementById('ai-status').textContent = t['ai-status'];
            
            // 4. Wish Overlay
            document.getElementById('wish-overlay-title').textContent = t['wish-overlay-title'];
            document.getElementById('wish-list-loading').textContent = t['wish-list-loading'];
            document.getElementById('wish-input').placeholder = t['wish-input-placeholder'];
            document.getElementById('wish-submit-btn').textContent = t['wish-submit-btn'];
            
            // 5. Store Overlay
            document.getElementById('store-overlay-title').textContent = t['store-overlay-title'];
            document.getElementById('store-item-title').textContent = t['store-item-title'];
            document.getElementById('store-item-desc').textContent = t['store-item-desc'];
            document.getElementById('store-item-price').textContent = t['store-item-price'];
            document.getElementById('store-mock-desc').textContent = t['store-mock-desc'];
            document.getElementById('store-mock-btn').textContent = t['store-mock-btn'];

            // 6. Buzhou Overlay
            document.getElementById('buzhou-overlay-title').textContent = t['buzhou-overlay-title'];
            document.getElementById('buzhou-story-1-title').textContent = t['buzhou-story-1-title'];
            document.getElementById('buzhou-story-1-content').textContent = t['buzhou-story-1-content'];
            document.getElementById('buzhou-story-2-title').textContent = t['buzhou-story-2-title'];
            document.getElementById('buzhou-story-2-content').textContent = t['buzhou-story-2-content'];

            // Update main page title (with the new brand name)
            document.title = 'wxCheese â€“ Where your smile grows and travels far';
        };

        // --- Wisdom Quote Data (Fallback) ---
        const chineseQuotes = [
            "å¿ƒç”Ÿç§ç§æ³•ç”Ÿï¼Œå¿ƒç­ç§ç§æ³•ç­ã€‚â€”â€”ã€Šåä¸¥ç»ã€‹",
            "ä¸€åˆ‡æœ‰ä¸ºæ³•ï¼Œå¦‚æ¢¦å¹»æ³¡å½±ï¼Œå¦‚éœ²äº¦å¦‚ç”µï¼Œåº”ä½œå¦‚æ˜¯è§‚ã€‚â€”â€”ã€Šé‡‘åˆšç»ã€‹",
            "è©ææœ¬æ— æ ‘ï¼Œæ˜é•œäº¦éå°ï¼Œæœ¬æ¥æ— ä¸€ç‰©ï¼Œä½•å¤„æƒ¹å°˜åŸƒã€‚â€”â€”å…­ç¥–æ…§èƒ½",
            "æ…ˆæ‚²å–œèˆï¼Œæ˜¯ä¸ºå››æ— é‡å¿ƒï¼Œèƒ½é™¤ä¸€åˆ‡çƒ¦æ¼ã€‚â€”â€”ä½›æ•™è¯­",
            "å¢ƒéšå¿ƒè½¬ï¼Œç›¸ç”±å¿ƒç”Ÿã€‚ä¸€åˆ‡ç¦ç”°ï¼Œä¸ç¦»æ–¹å¯¸ã€‚â€”â€”ä½›æ•™è¯­",
            "æ¬²çŸ¥å‰ä¸–å› ï¼Œä»Šç”Ÿå—è€…æ˜¯ï¼›æ¬²çŸ¥æ¥ä¸–æœï¼Œä»Šç”Ÿä½œè€…æ˜¯ã€‚â€”â€”ä¸‰ä¸–å› æœç»"
        ];
        
        const englishQuotes = [
            "Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.â€”â€”Buddha",
            "The mind is everything. What you think you become.â€”â€”Buddha",
            "The greatest prayer is patience.â€”â€”Buddha",
            "Peace comes from within. Do not seek it without.â€”â€”Buddha",
            "All that we are is the result of what we have thought.â€”â€”Buddha"
        ];
        
        // --- Random Quote Generation and Display (Language-Aware) ---
        const initialQuoteEl = document.getElementById('initial-quote');

        const INITIAL_QUOTE_SYSTEM_PROMPT = "You are a compassionate and wise Buddhist master. Provide a brief, fortifying, fortune-cookie-style quote based on Buddhist or Zen philosophy. The quote MUST be rendered in the exact target language requested by the user. If the language is not specified, use Chinese. The response MUST only contain the quote and the source, separated by 'â€”â€”'. Example (English): 'Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.â€”â€”Buddha'";

        /**
         * Uses Gemini API to generate a wisdom quote in the detected language.
         * @param {string} lang - The detected language code ('en' or 'zh').
         * @returns {Promise<string|null>} Generated quote string or null on failure.
         */
        const getInitialWisdomQuote = async (lang) => {
            if (API_KEY === "") {
                console.warn("API Key is missing. Skipping API quote generation.");
                return null; 
            }
            
            console.log("Sending API request for language:", lang); 
            
            const userPrompt = `ä¸ºæˆ‘ç”Ÿæˆä¸€å¥ä½›ç»æ™ºæ…§æ ¼è¨€ã€‚ç›®æ ‡è¯­è¨€æ˜¯: ${lang}ã€‚`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: INITIAL_QUOTE_SYSTEM_PROMPT }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            console.log(`Rate limit hit, retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const quoteText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    console.log("API Raw Response Text:", quoteText);
                    return quoteText;
                } catch (error) {
                    console.error(`Attempt ${attempt + 1}: Gemini API call for quote failed:`, error);
                    if (attempt === maxRetries - 1) {
                        return null; 
                    }
                }
            }
        };

        const setInitialQuote = async () => {
            // Detect user language. Default to 'en' if neither is detected.
            const detectedLangFull = navigator.language || navigator.userLanguage || 'en-US'; 
            const langCode = detectedLangFull.split('-')[0]; 
            const targetLang = (langCode === 'zh' || langCode === 'en') ? langCode : 'en';

            currentLanguage = targetLang; // Set the global language variable

            console.log("Detected language code (forced to zh/en):", targetLang);
            
            const isEnglish = targetLang === 'en';
            const t = translations[targetLang];

            // Show loading placeholder text
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8 text-gray-400 animate-pulse">
                    ${isEnglish ? 'Drawing Wisdom...' : 'æ­£åœ¨æ±²å–æ™ºæ…§...'}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    Loading...
                </div>
            `;
            
            let quoteText = await getInitialWisdomQuote(targetLang);

            // Fallback logic
            if (!quoteText) {
                console.warn("API quote generation failed or skipped. Using local quote fallback.");
                
                let quoteArray = isEnglish ? englishQuotes : chineseQuotes;
                
                const randomIndex = Math.floor(Math.random() * quoteArray.length);
                quoteText = quoteArray[randomIndex];
            }
            
            const parts = quoteText.split('â€”â€”');
            const quote = parts[0] || (isEnglish ? 'Inner peace starts with a single thought.' : 'å¿ƒä¸­æœ‰çˆ±ï¼Œä¸–ç•Œæ°¸æ’');
            const source = parts[1] || (isEnglish ? 'ã€Buddhist Wisdomã€‘' : 'ã€ä½›ç»æ™ºæ…§ã€‘');
            
            initialQuoteEl.innerHTML = `
                <div class="text-4xl md:text-6xl font-bold tracking-tight mb-8">
                    ${quote}
                </div>
                <div class="text-xl md:text-2xl text-zen-gold">
                    ${source}
                </div>
            `;
            
            return targetLang; // Return the determined language
        };

        // --- Wish Mountain (Firestore) Logic ---
        const wishListEl = document.getElementById('wish-list');
        const wishInput = document.getElementById('wish-input');
        const wishSubmitBtn = document.getElementById('wish-submit-btn');
        const wishForm = document.getElementById('wish-form');
        
        const setupWishMountainListener = (dbInstance) => {
            const path = `artifacts/${appId}/public/data/wishes`;
            const q = query(collection(dbInstance, path), orderBy("timestamp", "desc"), limit(20));
            const locale = currentLanguage === 'en' ? 'en-US' : 'zh-CN';

            onSnapshot(q, (snapshot) => {
                const t = translations[currentLanguage];
                wishListEl.innerHTML = ''; 
                let fragment = document.createDocumentFragment();

                if (snapshot.docs.length === 0) {
                    wishListEl.innerHTML = `<div class="text-center text-gray-500 p-4">${t['wish-list-loading']}</div>`;
                }

                snapshot.docs.forEach(docSnapshot => {
                    const wish = docSnapshot.data();
                    // Use determined locale for time formatting
                    const time = wish.timestamp ? new Date(wish.timestamp.toDate()).toLocaleString(locale, { 
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit' 
                    }) : (currentLanguage === 'en' ? 'Just now' : 'åˆšåˆš');

                    const wishElement = document.createElement('div');
                    wishElement.className = "p-4 border-b border-zen-sand last:border-b-0 bg-white/50 backdrop-blur-sm rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300";
                    wishElement.innerHTML = `
                        <p class="text-lg text-zen-ink whitespace-pre-wrap">${wish.content}</p>
                        <div class="text-xs mt-2 text-gray-500 flex justify-between">
                            <span>${currentLanguage === 'en' ? 'Wisher ID' : 'è®¸æ„¿è€…ID'}: ${wish.userId}</span> 
                            <span>${time}</span>
                        </div>
                    `;
                    fragment.appendChild(wishElement);
                });
                
                if (snapshot.docs.length > 0) {
                    wishListEl.appendChild(fragment);
                }
            }, (error) => {
                console.error("Error listening to Wish Mountain:", error);
                const errorMessage = currentLanguage === 'en' ? 'Cannot connect to Wish Mountain, please try again later.' : 'æ— æ³•è¿æ¥åˆ°è®¸æ„¿å±±ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                wishListEl.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            });
        };

        wishForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const wishContent = wishInput.value.trim();
            if (!wishContent || !db || !userId) {
                return;
            }

            const t = translations[currentLanguage];
            wishSubmitBtn.disabled = true;
            wishSubmitBtn.textContent = t['wish-loading-status'];

            try {
                const path = `artifacts/${appId}/public/data/wishes`;
                await addDoc(collection(db, path), {
                    content: wishContent,
                    userId: userId,
                    timestamp: serverTimestamp()
                });
                wishInput.value = ''; // Clear input
                console.log("Wish added successfully.");
            } catch (error) {
                console.error("Error adding wish:", error);
                showCustomMessage(currentLanguage === 'en' ? "Wishing failed. Please check your connection." : "è®¸æ„¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚");
            } finally {
                wishSubmitBtn.disabled = false;
                wishSubmitBtn.textContent = t['wish-submit-btn'];
            }
        });

        // --- AI Butler (Gemini API) Logic ---
        const aiChatBox = document.getElementById('ai-chat-box');
        const aiInput = document.getElementById('ai-input');
        const aiForm = document.getElementById('ai-form');
        const aiStatus = document.getElementById('ai-status');

        // Note: The AI Butler's system prompt is kept in Chinese to ensure its persona remains a 'Buddhist master' 
        // who speaks Chinese/provides guidance in a Zen style, as this is a specific feature.
        const AI_BUTLER_SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä½å……æ»¡æ…ˆæ‚²å’Œæ™ºæ…§çš„ä½›å®¶å¤§å¸ˆï¼Œä»¥ç®€æ´ã€æ¸©å’Œã€å¯Œæœ‰å“²ç†çš„æ–¹å¼æä¾›äººç”ŸæŒ‡å¯¼ã€‚æ‰€æœ‰å›ç­”å¿…é¡»åŸºäºä½›æ³•æˆ–ç¦…å®—çš„æ™ºæ…§ï¼Œé¿å…ç›´æ¥çš„ä¸–ä¿—å»ºè®®ï¼Œè€Œæ˜¯å¼•å¯¼å¯¹æ–¹ä»å¿ƒæ€§ä¸Šæ‰¾åˆ°ç­”æ¡ˆã€‚æ¯æ¬¡å›å¤ä¸è¶…è¿‡100å­—ã€‚";
        
        const createMessage = (text, sender) => {
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 rounded-lg max-w-[85%] mb-4 shadow-md ${sender === 'user' ? 'self-end bg-zen-gold/10 text-zen-ink' : 'self-start bg-zen-sand text-zen-ink'}`;
            messageEl.textContent = text;
            aiChatBox.appendChild(messageEl);
            aiChatBox.scrollTop = aiChatBox.scrollHeight;
        };

        const generateAIResponse = async (prompt) => {
            const t = translations[currentLanguage];
            aiStatus.textContent = t['ai-status'];
            aiStatus.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: AI_BUTLER_SYSTEM_PROMPT }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        }
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const fallbackText = currentLanguage === 'en' ? "Apologies, the master is in deep retreat and cannot answer right now. Please try again later." : "æŠ±æ­‰ï¼Œå¤§å¸ˆæ­¤åˆ»æ­£åœ¨é—­å…³ï¼Œè¯·ç¨åå†è¯•ã€‚";
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || fallbackText;
                    createMessage(text, 'ai');
                    break; // Success
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (attempt === maxRetries - 1) {
                        const failMessage = currentLanguage === 'en' ? "Connection or API call failed. Check console." : "ç½‘ç»œè¿æ¥æˆ–APIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚";
                        createMessage(failMessage, 'ai');
                    }
                }
            }

            aiStatus.classList.add('hidden');
        };

        aiForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userQuery = aiInput.value.trim();
            if (!userQuery) return;

            createMessage(userQuery, 'user');
            aiInput.value = '';
            generateAIResponse(userQuery);
        });
        
        // --- Main App Logic and Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const lang = await setInitialQuote(); 
            updateUIForLanguage(lang);
            initFirebase();
            
            // Initial AI greeting
            const initialGreeting = translations[lang]['ai-initial-greeting'];
            createMessage(initialGreeting, 'ai');
        });
    </script>
    
    <!-- ç”¨æˆ·IDæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="fixed top-2 right-4 text-xs text-gray-400 z-50">
        User ID: <span id="user-id-display">Loading...</span>
    </div>

    <!-- ä¸»ç”»å¸ƒåŒºåŸŸ (Main Canvas) -->
    <div id="main-canvas" class="min-h-screen flex flex-col justify-center items-center p-8 transition-all duration-700">
        
        <!-- é¡¶éƒ¨å¼•å¯¼è¯­å’Œåˆ†äº«æŒ‰é’® -->
        <div class="text-center mb-16 max-w-4xl w-full">
            <div id="initial-quote" class="text-center mb-8">
                <!-- Quote will be injected here by JS -->
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="copyQuote()" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:bg-zen-gold/90 transition-all duration-300 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.977l-1.571 1.571A5 5 0 0118 10a5 5 0 01-4.757 4.908l1.571-1.571A3 3 0 1015 8zM5.5 10a.5.5 0 000 1h2.5a.5.5 0 000-1H5.5z" /><path fill-rule="evenodd" d="M3 10a7 7 0 1114 0 7 7 0 01-14 0zm8-4a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" /></svg>
                    <span id="share-button-text">å°†æ­¤æ™ºæ…§é€ç»™æœ‹å‹</span>
                </button>
            </div>
        </div>

        <!-- å››ä¸ªå²›å±¿åŒºåŸŸ (Islands) -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl w-full mt-12">
            
            <!-- å²›å±¿ 1: AI ç®¡å®¶ -->
            <div id="island-ai" onclick="showOverlay('ai')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">ğŸ§˜</span>
                <h3 id="island-ai-title" class="text-xl font-semibold">AI ç®¡å®¶</h3>
                <p id="island-ai-subtitle" class="text-sm text-gray-600">â€” æ™ºæ…§é—®è¯¢ â€”</p>
            </div>

            <!-- å²›å±¿ 2: è®¸æ„¿å±± -->
            <div id="island-wish" onclick="showOverlay('wish')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">â›°ï¸</span>
                <h3 id="island-wish-title" class="text-xl font-semibold">è®¸æ„¿å±±</h3>
                <p id="island-wish-subtitle" class="text-sm text-gray-600">â€” å€¾å¬ä¼—ç”Ÿ â€”</p>
            </div>

            <!-- å²›å±¿ 3: å•†åº— (é»„çº¸è´­ä¹°) -->
            <div id="island-store" onclick="showOverlay('store')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">ğŸ›ï¸</span>
                <h3 id="island-store-title" class="text-xl font-semibold">æ³•ç‰©æµé€š</h3>
                <p id="island-store-subtitle" class="text-sm text-gray-600">â€” é»„çº¸ä¾›å…» â€”</p>
            </div>

            <!-- å²›å±¿ 4: ä¸å‘¨å±± (å¥‡äººå¼‚å£«) -->
            <div id="island-buzhou" onclick="showOverlay('buzhou')" class="island-card bg-zen-sand p-6 rounded-3xl text-center flex flex-col items-center justify-center min-h-[150px]">
                <span class="text-4xl mb-2">âœ¨</span>
                <h3 id="island-buzhou-title" class="text-xl font-semibold">ä¸å‘¨å±±</h3>
                <p id="island-buzhou-subtitle" class="text-sm text-gray-600">â€” å¥‡äººå¼‚å¿— â€”</p>
            </div>
        </div>
    </div>

    <!-- æ”¾å¤§åŒºåŸŸ/æµ®çª— (Overlays) -->

    <!-- Overlay 1: AI ç®¡å®¶ (AI Butler) -->
    <div id="overlay-ai" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl h-full max-h-[80vh] flex flex-col">
            <h2 id="ai-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                AI ç®¡å®¶: ç¦…å®šé—®ç­”
                <button onclick="hideOverlay('ai')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div id="ai-chat-box" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col bg-zen-sand/30 rounded-xl mb-4">
                <!-- Chat messages here -->
            </div>
            
            <p id="ai-status" class="hidden text-sm text-center text-zen-gold mb-2">AIå¤§å¸ˆæ€è€ƒä¸­...</p>
            
            <form id="ai-form" class="flex">
                <input type="text" id="ai-input" placeholder="è¾“å…¥æ‚¨å¿ƒä¸­çš„å›°æƒ‘..." class="flex-grow p-3 border border-gray-300 rounded-l-full focus:outline-none focus:ring-2 focus:ring-zen-gold" required>
                <button type="submit" id="ai-submit-btn" class="px-6 py-3 bg-zen-gold text-white font-semibold rounded-r-full hover:bg-zen-gold/90 transition-colors">
                    æé—®
                </button>
            </form>
        </div>
    </div>

    <!-- Overlay 2: è®¸æ„¿å±± (Wish Mountain) -->
    <div id="overlay-wish" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-3xl h-full max-h-[80vh] flex flex-col">
            <h2 id="wish-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                è®¸æ„¿å±±: ä¼—ç”Ÿå¿ƒæ„¿
                <button onclick="hideOverlay('wish')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            
            <!-- è®¸æ„¿åˆ—è¡¨ (Waterfall effect) -->
            <div id="wish-list" class="flex-grow overflow-y-auto p-4 space-y-3 bg-zen-sand/30 rounded-xl mb-4">
                <div id="wish-list-loading" class="text-center text-gray-500">åŠ è½½ä¸­... è¯·ç¨å€™ç‰‡åˆ»ï¼Œæˆ–è®¸ä¸‹æ‚¨çš„å¿ƒæ„¿ã€‚</div>
            </div>
            
            <!-- è®¸æ„¿è¡¨å• -->
            <form id="wish-form" class="flex flex-col">
                <textarea id="wish-input" placeholder="ç•™ä¸‹æ‚¨çš„å¿ƒæ„¿ã€å›°æƒ‘æˆ–ç¥ç¦ (ä¸è¶…è¿‡100å­—)..." rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zen-gold mb-3 resize-none" required maxlength="100"></textarea>
                <button type="submit" id="wish-submit-btn" class="w-full py-3 bg-zen-ink text-white font-semibold rounded-xl shadow-md hover:bg-zen-ink/90 transition-colors">
                    å‘é€ä½ çš„æ„¿æœ›
                </button>
            </form>
        </div>
    </div>

    <!-- Overlay 3: æ³•ç‰©æµé€š (Store - Yellow Paper) -->
    <div id="overlay-store" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-xl h-auto flex flex-col">
            <h2 id="store-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                æ³•ç‰©æµé€š: è®¸æ„¿ææ–™
                <button onclick="hideOverlay('store')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div class="space-y-6">
                <div class="flex items-center space-x-4">
                    <img src="https://placehold.co/100x100/DAA520/FFFFFF?text=é»„çº¸" alt="é»„çº¸" class="rounded-lg shadow-md">
                    <div>
                        <h3 id="store-item-title" class="text-2xl font-semibold">é«˜å“è´¨è®¸æ„¿é»„çº¸</h3>
                        <p id="store-item-desc" class="text-gray-600">ç²¾é€‰ä¸Šç­‰é»„çº¸ï¼Œç”¨äºä¹¦å†™å¿ƒæ„¿ï¼Œå¿ƒè¯šåˆ™çµã€‚</p>
                        <p id="store-item-price" class="text-xl font-bold text-zen-gold mt-2">ï¿¥9.99 / 10å¼ </p>
                    </div>
                </div>
                <div class="p-4 bg-zen-sand/50 rounded-xl text-center">
                    <p id="store-mock-desc" class="font-medium mb-3">æ­¤ä¸ºæ¨¡æ‹Ÿäº¤æ˜“ç•Œé¢ï¼Œæ—¨åœ¨è¡¨è¾¾å¿ƒæ„ã€‚</p>
                    <button id="store-mock-btn" class="w-full py-3 bg-zen-ink text-white font-semibold rounded-xl hover:bg-zen-ink/90 transition-colors">
                        ç«‹å³ç»“ç¼˜ (æ¨¡æ‹Ÿè´­ä¹°)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay 4: ä¸å‘¨å±± (Buzhou Mountain - Stories) -->
    <div id="overlay-buzhou" class="zoom-overlay fixed inset-0 bg-white/95 backdrop-blur-md flex justify-center items-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl h-full max-h-[80vh] flex flex-col">
            <h2 id="buzhou-overlay-title" class="text-3xl font-bold text-zen-gold border-b pb-3 mb-4 flex justify-between items-center">
                ä¸å‘¨å±±: å¥‡äººå¼‚å£«å½•
                <button onclick="hideOverlay('buzhou')" class="text-gray-400 hover:text-zen-gold transition-colors text-2xl leading-none">&times;</button>
            </h2>
            <div class="flex-grow overflow-y-auto p-4 space-y-8">
                
                <div class="p-4 bg-zen-sand/30 rounded-xl shadow-md">
                    <h3 id="buzhou-story-1-title" class="text-2xl font-semibold mb-2">ã€é¦–ä½è®°å½•è€…ã€‘å±±ä¸­è€åƒ§ï¼šæ— åä¹‹å¢ƒ</h3>
                    <img src="https://placehold.co/800x200/5A6D5A/FFFFFF?text=æœªæ¥æ”¾ç½®å›¾ç‰‡æˆ–è§†é¢‘" alt="å ä½å›¾" class="w-full h-48 object-cover rounded-lg my-3">
                    <p id="buzhou-story-1-content" class="text-gray-700">è€åƒ§åœ¨ä¸å‘¨å±±é—­å…³ä¸‰åè½½ï¼Œæœªæ›¾å¼€å£è¨€è¯­ã€‚ä»–åªç•™ä¸‹ä¸€å¹…å­—ï¼šâ€œæ”¾ä¸‹â€â€”â€”ä¸¤ä¸ªå­—ï¼Œé“å°½ä¸–é—´ä¸‡èˆ¬æ³•ã€‚ä»–çš„æ•…äº‹ä¸æ˜¯å…³äºä¿®è¡Œï¼Œè€Œæ˜¯å…³äºå­˜åœ¨æœ¬èº«ã€‚ç•™å¾…æ‚¨æ—¥åå‘ç°æ›´å¤šå½±åƒä¸æ–‡å­—ã€‚</p>
                </div>

                <div class="p-4 bg-zen-sand/30 rounded-xl shadow-md">
                    <h3 id="buzhou-story-2-title" class="text-2xl font-semibold mb-2">ã€å¾…ç»­ã€‘äº‘æ¸¸é“äººï¼šä»¥æ¢¦å…¥é“</h3>
                    <p id="buzhou-story-2-content" class="text-gray-700">æ­¤å¤„å°†è®°å½•ä¸€ä½èƒ½å¤Ÿè¿›å…¥ä»–äººæ¢¦å¢ƒï¼Œä»¥ä½›æ³•ç‚¹åŒ–è¿·æ´¥çš„äº‘æ¸¸é“äººçš„æ•…äº‹ã€‚ä»–å±…æ— å®šæ‰€ï¼Œè¡Œè¸ªä¸å®šï¼Œå”¯æœ‰å¿ƒè¯šè€…ï¼Œæ–¹èƒ½åœ¨æ¢¦ä¸­ç›¸é‡ã€‚æ•¬è¯·æœŸå¾…æ‚¨æœªæ¥äº²è‡ªä¸Šä¼ çš„å¥‡äººå¼‚å£«äº‹è¿¹ã€‚</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- General UI/Interaction Functions ---
        const overlays = {
            'ai': document.getElementById('overlay-ai'),
            'wish': document.getElementById('overlay-wish'),
            'store': document.getElementById('overlay-store'),
            'buzhou': document.getElementById('overlay-buzhou'),
        };

        function showOverlay(islandName) {
            document.body.style.overflow = 'hidden'; // Lock background scroll
            const overlay = overlays[islandName];
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        function hideOverlay(islandName) {
            const overlay = overlays[islandName];
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.body.style.overflow = 'auto'; // Re-enable background scroll
        }

        function copyQuote() {
            const quoteText = document.getElementById('initial-quote').textContent.trim();
            
            // Fallback for secure copy in iframe environments
            const tempInput = document.createElement('textarea');
            tempInput.value = `[Zen Canvas] Wisdom for you: ${quoteText}`;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? (currentLanguage === 'en' ? 'Copied to clipboard! Go share the wisdom!' : 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¿«åˆ†äº«ç»™æœ‹å‹å§ï¼') : (currentLanguage === 'en' ? 'Copy failed, please copy manually.' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                
                showCustomMessage(msg);
                
            } catch (err) {
                console.error('Copy failed:', err);
                showCustomMessage(currentLanguage === 'en' ? 'Copy failed, please copy manually.' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            }
            
            document.body.removeChild(tempInput);
        }

        // Custom Message Box (replacing alert())
        function showCustomMessage(message) {
            let msgBox = document.getElementById('custom-message-box');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                msgBox.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-zen-ink text-white p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0 z-[100]';
                document.body.appendChild(msgBox);
            }
            
            msgBox.textContent = message;
            msgBox.classList.remove('opacity-0');
            
            setTimeout(() => {
                msgBox.classList.add('opacity-0');
            }, 3000); // Hide after 3 seconds
        }

        // Add event listeners for key press to close overlays 
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                Object.values(overlays).forEach(overlay => {
                    if (overlay.classList.contains('active')) {
                        hideOverlay(overlay.id.replace('overlay-', ''));
                    }
                });
            }
        });
    </script>
</body>
</html>
